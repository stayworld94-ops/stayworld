<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>STAYWORLD ‚Äî Hotels</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>

  <style>
    :root{
      --bg:#0b0f16;--panel:#101018;--panel-2:#0f131c;--text:#e7e9ee;--muted:#aeb6c8;--line:rgba(255,255,255,.08);
      --chip:#121a26;--gold1:#f4d78c;--gold2:#c9a35b;--accent:#1e5bd8;--green:#2ecc71;--danger:#ff5a5f
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}

    /* Header */
    .sw-header{position:sticky;top:0;z-index:100;background:rgba(10,14,20,.85);backdrop-filter:blur(10px);border-bottom:1px solid var(--line)}
    .sw-header-inner{max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:16px;padding:10px 16px}
    .sw-brand{display:flex;align-items:center;gap:10px;color:var(--text);text-decoration:none}
    .sw-logo{width:30px;height:30px;border-radius:50%;background:radial-gradient(circle at 30% 30%,#fff8dd 0,#f4d78c 45%,#c9a35b 70%,#8a6d33 100%)}
    .sw-nav{margin-left:auto;display:flex;gap:14px}
    .sw-nav a{color:var(--muted);text-decoration:none;padding:8px 10px;border-radius:10px}
    .sw-nav a:hover{background:var(--chip);color:var(--text)}
    .sw-nav a.active{color:var(--gold1);border:1px solid var(--line);background:linear-gradient(180deg,rgba(27,27,36,.6),rgba(27,27,36,.2))}
    .sw-cta{display:flex;gap:10px;margin-left:8px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;text-decoration:none;border:1px solid var(--line);color:var(--text);cursor:pointer}
    .btn.gold{background:linear-gradient(180deg,#f4d78c,#c9a35b);color:#121212;border:none;font-weight:800}
    .btn.ghost:hover{background:var(--chip)}
    @media(max-width:880px){.sw-nav,.sw-cta{display:none}}

    /* Top controls */
    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;padding:12px 14px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,rgba(16,16,24,.7),rgba(16,16,24,0))}
    .chip{display:inline-flex;gap:8px;align-items:center;padding:9px 12px;background:var(--chip);border:1px solid var(--line);border-radius:12px;color:var(--text);cursor:pointer}
    .chip:hover{background:#152033}
    .select{padding:8px 10px;border-radius:10px;background:var(--panel);border:1px solid var(--line);color:var(--text)}

    /* Layout */
    .wrap{display:grid;grid-template-columns:1.15fr .85fr;gap:16px;padding:14px}
    @media(max-width:1024px){.wrap{grid-template-columns:1fr}}

    /* Cards */
    .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.25);margin-bottom:14px}
    .card-media{position:relative}
    .card-media img{width:100%;height:210px;object-fit:cover;display:block}
    .badge-row{position:absolute;top:10px;left:10px;display:flex;gap:8px}
    .badge{background:rgba(0,0,0,.6);backdrop-filter:blur(6px);border:1px solid var(--line);color:#fff;padding:6px 8px;border-radius:10px;font-size:12px}
    .fav{position:absolute;right:12px;top:12px;width:36px;height:36px;border-radius:12px;background:rgba(0,0,0,.5);display:grid;place-items:center;border:1px solid var(--line);cursor:pointer}
    .fav svg{fill:transparent;stroke:#fff;stroke-width:1.6}
    .fav.active svg{fill:var(--danger);stroke:var(--danger)}
    .card-body{display:grid;grid-template-columns:1fr auto;gap:12px;padding:12px 14px 16px}
    .title{font-weight:700;font-size:18px}
    .rating{justify-self:end;align-self:start;background:#2b6bed;border:1px solid rgba(255,255,255,.15);color:#fff;padding:6px 10px;border-radius:10px;font-weight:700}
    .meta{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:14px}
    .payline{margin-top:6px;display:flex;gap:10px;align-items:baseline}
    .old-price{text-decoration:line-through;color:#8b94a8}
    .price{font-size:20px;font-weight:800;color:var(--gold1)}
    .tax{color:var(--muted);font-size:12px}
    .cancel{margin-top:4px;color:var(--green);font-size:14px}
    .card .book{margin-top:10px;display:inline-flex}

    /* Map */
    #map{height:520px;border:1px solid var(--line);border-radius:16px;overflow:hidden}
    .price-bubble{background:var(--accent);color:#fff;border-radius:10px;padding:4px 8px;font-weight:800;border:2px solid rgba(255,255,255,.8);box-shadow:0 6px 12px rgba(0,0,0,.4)}

    /* Footer */
    footer.sw-footer{margin-top:24px;border-top:1px solid var(--line);background:linear-gradient(180deg,rgba(16,16,24,.7),rgba(16,16,24,0));padding:24px 16px}
    .sw-footer-inner{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
    .sw-foot-col h4{margin:0 0 10px 0;color:var(--gold1)}
    .sw-foot-col a{display:block;color:var(--muted);text-decoration:none;margin:6px 0}
    .sw-foot-col a:hover{color:var(--text)}
    .sw-copy{max-width:1200px;margin:6px auto 0 auto;color:var(--muted);font-size:12px}

    /* Filter drawer */
    .filter-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(2px);display:none;z-index:120}
    .filter-panel{position:fixed;right:0;top:0;bottom:0;width:360px;max-width:92vw;background:var(--panel);border-left:1px solid var(--line);box-shadow:-10px 0 30px rgba(0,0,0,.4);z-index:130;transform:translateX(100%);transition:transform .25s ease}
    .filter-open .filter-panel{transform:translateX(0)}
    .filter-open .filter-backdrop{display:block}
    .filter-head{display:flex;align-items:center;justify-content:space-between;padding:14px;border-bottom:1px solid var(--line)}
    .filter-body{padding:14px;display:grid;gap:16px;overflow:auto;height:calc(100% - 150px)}
    .filter-row{display:grid;gap:8px}
    .filter-row label{color:var(--muted);font-size:13px}
    .range{display:flex;gap:10px;align-items:center}
    .range input[type=range]{width:100%}
    .filter-actions{display:flex;gap:10px;padding:12px;border-top:1px solid var(--line);background:linear-gradient(180deg,rgba(16,16,24,.6),rgba(16,16,24,0))}
    .btn.small{padding:8px 10px;border-radius:10px}
    .btn.reset{background:transparent;color:var(--muted)}
  </style>
</head>
<body>
  <!-- Header -->
  <header class="sw-header">
    <div class="sw-header-inner">
      <a href="/index.html" class="sw-brand"><span class="sw-logo"></span><strong>STAYWORLD</strong></a>
      <nav class="sw-nav">
        <a href="/index.html">Home</a>
        <a href="/hotels.html" class="active">Hotels</a>
        <a href="/membership.html">Membership</a>
        <a href="/results.html">Search</a>
        <a href="/host-register.html">Become a Host</a>
      </nav>
      <div class="sw-cta">
        <a href="/login.html" class="btn ghost">Log in</a>
        <a href="/signup.html" class="btn gold">Sign up</a>
      </div>
    </div>
  </header>

  <!-- Controls -->
  <div class="controls">
    <div class="chip" id="btnSort">‚áÖ <span data-i18n="sort">Ï†ïÎ†¨</span></div>
    <div class="chip" id="btnFilter">‚ò∞ <span data-i18n="filter">ÌïÑÌÑ∞</span></div>
    <div class="chip" id="btnMapList">üó∫Ô∏è <span data-i18n="mapView">ÏßÄÎèÑ</span></div>
    <select class="select" id="lang"></select>
    <select class="select" id="currency"></select>
  </div>

  <!-- Filter Drawer -->
  <div class="filter-backdrop" id="filterBackdrop"></div>
  <aside class="filter-panel" id="filterPanel" aria-hidden="true">
    <div class="filter-head">
      <strong>Filters</strong>
      <button class="btn small reset" id="btnCloseFilter">‚úï</button>
    </div>
    <div class="filter-body">
      <div class="filter-row">
        <label>Max price (converted)</label>
        <div class="range">
          <input type="range" id="fPrice" min="50" max="1000" step="10" value="1000"/>
          <span id="fPriceVal">‚Äî</span>
        </div>
      </div>
      <div class="filter-row">
        <label>Minimum rating</label>
        <div class="range">
          <input type="range" id="fRating" min="0" max="10" step="0.1" value="0"/>
          <span id="fRatingVal">0.0</span>
        </div>
      </div>
      <div class="filter-row">
        <label>Max distance from center</label>
        <div class="range">
          <input type="range" id="fDistance" min="200" max="10000" step="100" value="10000"/>
          <span id="fDistanceVal">‚Äî</span>
        </div>
      </div>
      <div class="filter-row">
        <label><input type="checkbox" id="fFreeCancel"> Free cancellation only</label>
      </div>
    </div>
    <div class="filter-actions">
      <button class="btn small reset" id="btnResetFilters">Reset</button>
      <button class="btn small gold" id="btnApplyFilters">Apply</button>
    </div>
  </aside>

  <!-- List + Map -->
  <div class="wrap">
    <div><div id="list"></div></div>
    <div>
      <div id="map"></div>
      <div style="padding:8px 14px;color:var(--muted);font-size:12px" id="rateHint">* Exchange rates are sample for demo. Connect your FX API for live rates.</div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="sw-footer">
    <div class="sw-footer-inner">
      <div class="sw-foot-col"><h4>STAYWORLD</h4><a href="/about.html">About</a><a href="/careers.html">Careers</a><a href="/press.html">Press</a></div>
      <div class="sw-foot-col"><h4>Help</h4><a href="/help.html">Help Center</a><a href="/safety.html">Guest Protection</a><a href="/contact.html">Contact</a></div>
      <div class="sw-foot-col"><h4>Legal</h4><a href="/terms.html">Terms</a><a href="/privacy.html">Privacy</a><a href="/cookies.html">Cookies</a></div>
    </div>
    <div class="sw-copy">¬© 2025 STAYWORLD. All rights reserved.</div>
  </footer>

<script type="module">
  /* =========================
     City center & base state
  ========================== */
  let CITY_CENTER = { name:"Gda≈Ñsk", lat:54.352, lng:18.646 };
  let hotels = []; // realtime from Firestore

  /* =========================
     i18n (10 languages)
  ========================== */
  const LANGS = {
    en:{sort:'Sort',filter:'Filter',mapView:'Map',listView:'List',excellent:'Excellent',verygood:'Very good',superb:'Superb',reviews:'reviews',fromCenter:'from center',freeCancel:'Free cancellation',taxesIncluded:'Taxes & fees included',perStay:'total for 2 nights',currencyNote:'* Exchange rates are demo only.'},
    ko:{sort:'Ï†ïÎ†¨',filter:'ÌïÑÌÑ∞',mapView:'ÏßÄÎèÑ',listView:'Î¶¨Ïä§Ìä∏',excellent:'Ïö∞ÏàòÌï®',verygood:'Îß§Ïö∞ Ï¢ãÏùå',superb:'ÏïÑÏ£º ÌõåÎ•≠Ìï®',reviews:'Ïù¥Ïö©ÌõÑÍ∏∞',fromCenter:'ÎèÑÏã¨ÏóêÏÑú',freeCancel:'Î¨¥Î£å Ï∑®ÏÜå',taxesIncluded:'ÏÑ∏Í∏à Î∞è Í∏∞ÌÉÄÏöîÍ∏à Ìè¨Ìï®',perStay:'ÏÑ±Ïù∏ 2Î™Ö, 2Î∞ï ÏöîÍ∏à',currencyNote:'* ÌôòÏú®ÏùÄ Îç∞Î™®Ïö©ÏûÖÎãàÎã§.'},
    fr:{sort:'Trier',filter:'Filtrer',mapView:'Carte',listView:'Liste',excellent:'Excellent',verygood:'Tr√®s bien',superb:'Superbe',reviews:'avis',fromCenter:'du centre',freeCancel:'Annulation gratuite',taxesIncluded:'Taxes et frais inclus',perStay:'total pour 2 nuits',currencyNote:'* Taux de change de d√©monstration.'},
    tr:{sort:'Sƒ±rala',filter:'Filtre',mapView:'Harita',listView:'Liste',excellent:'M√ºkemmel',verygood:'√áok iyi',superb:'Harika',reviews:'yorum',fromCenter:'merkezden',freeCancel:'√úcretsiz iptal',taxesIncluded:'Vergi ve √ºcretler dahil',perStay:'2 gece toplam',currencyNote:'* Kurlar demodur.'},
    es:{sort:'Ordenar',filter:'Filtrar',mapView:'Mapa',listView:'Lista',excellent:'Excelente',verygood:'Muy bien',superb:'Estupendo',reviews:'rese√±as',fromCenter:'del centro',freeCancel:'Cancelaci√≥n gratuita',taxesIncluded:'Impuestos y tasas incluidos',perStay:'total por 2 noches',currencyNote:'* Tipos de cambio de demostraci√≥n.'},
    de:{sort:'Sortieren',filter:'Filter',mapView:'Karte',listView:'Liste',excellent:'Hervorragend',verygood:'Sehr gut',superb:'Fantastisch',reviews:'Bewertungen',fromCenter:'vom Zentrum',freeCancel:'Kostenlose Stornierung',taxesIncluded:'Steuern & Geb√ºhren inkl.',perStay:'gesamt f√ºr 2 N√§chte',currencyNote:'* Demo-Wechselkurse.'},
    it:{sort:'Ordina',filter:'Filtra',mapView:'Mappa',listView:'Elenco',excellent:'Eccellente',verygood:'Ottimo',superb:'Superbo',reviews:'recensioni',fromCenter:'dal centro',freeCancel:'Cancellazione gratuita',taxesIncluded:'Tasse e oneri inclusi',perStay:'totale per 2 notti',currencyNote:'* Tassi di cambio dimostrativi.'},
    ru:{sort:'–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞',filter:'–§–∏–ª—å—Ç—Ä',mapView:'–ö–∞—Ä—Ç–∞',listView:'–°–ø–∏—Å–æ–∫',excellent:'–ü—Ä–µ–≤–æ—Å—Ö–æ–¥–Ω–æ',verygood:'–û—á–µ–Ω—å —Ö–æ—Ä–æ—à–æ',superb:'–ó–∞–º–µ—á–∞—Ç–µ–ª—å–Ω–æ',reviews:'–æ—Ç–∑—ã–≤–æ–≤',fromCenter:'–æ—Ç —Ü–µ–Ω—Ç—Ä–∞',freeCancel:'–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –æ—Ç–º–µ–Ω–∞',taxesIncluded:'–ù–∞–ª–æ–≥–∏ –∏ —Å–±–æ—Ä—ã –≤–∫–ª—é—á–µ–Ω—ã',perStay:'–∏—Ç–æ–≥–æ –∑–∞ 2 –Ω–æ—á–∏',currencyNote:'* –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –∫—É—Ä—Å—ã.'},
    ja:{sort:'‰∏¶„ÅπÊõø„Åà',filter:'„Éï„Ç£„É´„Çø„Éº',mapView:'Âú∞Âõ≥',listView:'„É™„Çπ„Éà',excellent:'„Åô„Å∞„Çâ„Åó„ÅÑ',verygood:'„Å®„Å¶„ÇÇËâØ„ÅÑ',superb:'ÊúÄÈ´ò',reviews:'‰ª∂„ÅÆ„ÇØ„ÉÅ„Ç≥„Éü',fromCenter:'‰∏≠ÂøÉÈÉ®„Åã„Çâ',freeCancel:'„Ç≠„É£„É≥„Çª„É´ÁÑ°Êñô',taxesIncluded:'Á®é„ÉªÊâãÊï∞ÊñôËæº„Åø',perStay:'2Ê≥ä„ÅÆÂêàË®à',currencyNote:'* „É¨„Éº„Éà„ÅØ„Éá„É¢Áî®„Åß„Åô„ÄÇ'},
    zh:{sort:'ÊéíÂ∫è',filter:'Á≠õÈÄâ',mapView:'Âú∞Âõæ',listView:'ÂàóË°®',excellent:'ÂæàÊ£í',verygood:'ÈùûÂ∏∏Â•Ω',superb:'ÂçìË∂ä',reviews:'Êù°ÁÇπËØÑ',fromCenter:'Ë∑ù‰∏≠ÂøÉ',freeCancel:'ÂèØÂÖçË¥πÂèñÊ∂à',taxesIncluded:'Âê´Á®éË¥π',perStay:'ÂÖ±2Êôö',currencyNote:'* Ê±áÁéá‰ªÖ‰∏∫ÊºîÁ§∫„ÄÇ'}
  };
  const LANG_TO_DEFAULT_CURRENCY = { en:'USD', ko:'KRW', fr:'EUR', tr:'TRY', es:'EUR', de:'EUR', it:'EUR', ru:'RUB', ja:'JPY', zh:'CNY' };

  /* =========================
     Currency (sample rates)
  ========================== */
  const CURRENCIES = {
    USD:{sym:'US$',rate:1,dp:0}, EUR:{sym:'‚Ç¨',rate:0.92,dp:0}, KRW:{sym:'‚Ç©',rate:1350,dp:0},
    TRY:{sym:'‚Ç∫',rate:33,dp:0},  JPY:{sym:'¬•',rate:156,dp:0},  GBP:{sym:'¬£',rate:0.78,dp:0},
    RUB:{sym:'‚ÇΩ',rate:95,dp:0},  CNY:{sym:'¬•',rate:7.1,dp:0}
  };

  /* =========================
     DOM refs
  ========================== */
  const langSel=document.getElementById('lang');
  const curSel=document.getElementById('currency');
  const listEl=document.getElementById('list');
  const rateHint=document.getElementById('rateHint');

  for(const k of Object.keys(LANGS)){
    const o=document.createElement('option');
    o.value=k;
    o.textContent=new Intl.DisplayNames([k],{type:'language'}).of(k)||k;
    langSel.appendChild(o);
  }
  for(const k of Object.keys(CURRENCIES)){
    const o=document.createElement('option');
    o.value=k; o.textContent=`${k} ${CURRENCIES[k].sym}`;
    curSel.appendChild(o);
  }

  let state={lang:'ko',currency:'KRW',sort:'price-asc',filters:{priceMax:null,ratingMin:0,distanceMax:null,freeCancel:false}};
  langSel.value=state.lang; curSel.value=state.currency;

  /* =========================
     Utils
  ========================== */
  const toRad = d => d*Math.PI/180;
  function metersBetween(a,b){
    const R=6371000, dLat=toRad(b.lat-a.lat), dLon=toRad(b.lng-a.lng);
    const lat1=toRad(a.lat), lat2=toRad(b.lat);
    const h=Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
    return 2*R*Math.asin(Math.sqrt(h));
  }
  function formatDistance(m){ return m<950?`${Math.round(m/10)*10} m`:`${(m/1000).toFixed(1)} km`; }
  function t(key){ return (LANGS[state.lang]&&LANGS[state.lang][key])||LANGS.en[key]||key; }
  function money(usd){ const c=CURRENCIES[state.currency]; const val=usd*c.rate; return `${c.sym}${val.toFixed(c.dp)}`; }
  function badgeLabel(code){ const map={limited:{en:'Limited-time deal',ko:'Í∏∞Í∞Ñ ÌïúÏ†ï ÌäπÍ∞Ä'},mobileOnly:{en:'Mobile only',ko:'Î™®Î∞îÏùº Ï†ÑÏö© ÏöîÍ∏à'},genius:{en:'Genius',ko:'Genius'},new:{en:'New',ko:'Ïã†Í∑ú'}}; const l=map[code]||{en:code}; return l[state.lang]||l.en; }
  function ratingTextFromScore(score){ if(score>=9) return t('superb'); if(score>=8.5) return t('excellent'); if(score>=8) return t('verygood'); return ''; }
  const distanceFromCenter = h => metersBetween({lat:h.lat,lng:h.lng}, CITY_CENTER);

  /* =========================
     Render List
  ========================== */
  function renderList(){
    listEl.innerHTML='';
    const filtered=(hotels||[]).filter(h=>{
      const dist=distanceFromCenter(h);
      const priceConv=(h.priceUSD||0)*CURRENCIES[state.currency].rate;
      if(state.filters.priceMax && priceConv>state.filters.priceMax) return false;
      if(state.filters.ratingMin && (h.rating||0)<state.filters.ratingMin) return false;
      if(state.filters.distanceMax && dist>state.filters.distanceMax) return false;
      if(state.filters.freeCancel && !h.freeCancel) return false;
      return true;
    });

    const sorted=[...filtered].sort((a,b)=>{
      if(state.sort==='price-asc') return (a.priceUSD||0)-(b.priceUSD||0);
      if(state.sort==='price-desc') return (b.priceUSD||0)-(a.priceUSD||0);
      if(state.sort==='rating-desc') return (b.rating||0)-(a.rating||0);
      if(state.sort==='distance-asc') return distanceFromCenter(a)-distanceFromCenter(b);
      return 0;
    });

    for(const h of sorted){
      const dist=formatDistance(distanceFromCenter(h));
      const node=document.createElement('div'); node.className='card';
      node.innerHTML=`
        <div class="card-media">
          <img src="${h.photo||''}" alt="${h.name||''}">
          <div class="badge-row">${(h.badges||[]).map(b=>`<div class="badge">${badgeLabel(b)}</div>`).join('')}</div>
          <div class="fav" data-id="${h.id||''}" title="Favorite">
            <svg width="20" height="20" viewBox="0 0 24 24"><path d="M12 21s-6.716-4.279-9.428-7.012C.96 12.35.5 10.862.5 9.32.5 6.387 2.8 4 5.6 4c1.56 0 3.01.73 3.9 1.872A5.018 5.018 0 0 1 13.4 4c2.8 0 5.1 2.387 5.1 5.32 0 1.542-.46 3.03-2.072 4.668C18.716 16.721 12 21 12 21z"/></svg>
          </div>
        </div>
        <div class="card-body">
          <div>
            <div class="title">${h.name||''}</div>
            <div class="meta"><span class="distance">${t('fromCenter')} ${dist}</span></div>
            <div class="payline"><span class="old-price">${h.oldUSD?money(h.oldUSD):''}</span><span class="price">${money(h.priceUSD||0)}</span></div>
            <div class="tax">${t('taxesIncluded')} ‚Ä¢ ${t('perStay')}</div>
            <div class="cancel">${h.freeCancel?`‚úî ${t('freeCancel')}`:''}</div>
            <a href="/results.html?hotel=${encodeURIComponent(h.id||'')}&city=${encodeURIComponent(CITY_CENTER.name)}" class="btn gold book">Book</a>
          </div>
          <div class="rating">${(h.rating??'').toString()} <span style="font-weight:600;margin-left:6px">${ratingTextFromScore(h.rating||0)}</span><br><span style="font-size:12px;opacity:.85">${h.reviews||0} ${t('reviews')}</span></div>
        </div>`;
      listEl.appendChild(node);
    }

    // fav state
    document.querySelectorAll('.fav').forEach(el=>{
      const id=el.getAttribute('data-id');
      if(localStorage.getItem('fav:'+id)==='1') el.classList.add('active');
      el.addEventListener('click',()=>{
        el.classList.toggle('active');
        localStorage.setItem('fav:'+id, el.classList.contains('active')?'1':'0');
      });
    });
  }

  /* =========================
     Map
  ========================== */
  const map=L.map('map',{zoomControl:true,attributionControl:false}).setView([CITY_CENTER.lat,CITY_CENTER.lng],13);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{subdomains:'abcd',maxZoom:19}).addTo(map);
  let markers=[];
  function renderMarkers(){
    markers.forEach(m=>map.removeLayer(m)); markers=[];
    (hotels||[]).forEach(h=>{
      if(typeof h.lat!=='number'||typeof h.lng!=='number') return;
      const html=`<div class="price-bubble">${money(h.priceUSD||0)}</div>`;
      const icon=L.divIcon({className:'',html,iconSize:[10,10],iconAnchor:[20,20]});
      const m=L.marker([h.lat,h.lng],{icon}).addTo(map);
      m.bindPopup(`<b>${h.name||''}</b><br>${money(h.priceUSD||0)} ‚Ä¢ ${t('taxesIncluded')}<br>${t('fromCenter')} ${formatDistance(distanceFromCenter(h))}`);
      markers.push(m);
    });
    if(markers.length){
      const bounds=L.latLngBounds(markers.map(m=>m.getLatLng()));
      map.fitBounds(bounds.pad(0.2));
    }else{
      map.setView([CITY_CENTER.lat,CITY_CENTER.lng],13);
    }
  }

  /* =========================
     UI text sync
  ========================== */
  function syncUITexts(){
    document.querySelectorAll('[data-i18n]').forEach(el=>{el.textContent=t(el.getAttribute('data-i18n'))});
    rateHint.textContent=t('currencyNote');
    renderList(); renderMarkers();
  }

  // language / currency
  langSel.addEventListener('change',()=>{
    state.lang=langSel.value;
    if(LANG_TO_DEFAULT_CURRENCY[state.lang]){
      state.currency=LANG_TO_DEFAULT_CURRENCY[state.lang];
      curSel.value=state.currency;
    }
    syncUITexts();
  });
  curSel.addEventListener('change',()=>{ state.currency=curSel.value; renderList(); renderMarkers(); });

  // sort & filters
  document.getElementById('btnSort').addEventListener('click',()=>{
    const order=['price-asc','price-desc','rating-desc','distance-asc'];
    const idx=order.indexOf(state.sort);
    state.sort=order[(idx+1)%order.length];
    renderList();
  });

  const filterPanel=document.getElementById('filterPanel');
  const filterBackdrop=document.getElementById('filterBackdrop');
  const btnFilter=document.getElementById('btnFilter');
  const btnCloseFilter=document.getElementById('btnCloseFilter');
  const btnApplyFilters=document.getElementById('btnApplyFilters');
  const btnResetFilters=document.getElementById('btnResetFilters');
  function openFilters(){ document.body.classList.add('filter-open'); }
  function closeFilters(){ document.body.classList.remove('filter-open'); }
  btnFilter.addEventListener('click',openFilters);
  btnCloseFilter.addEventListener('click',closeFilters);
  filterBackdrop.addEventListener('click',closeFilters);

  const rngPrice=document.getElementById('fPrice');
  const rngRating=document.getElementById('fRating');
  const rngDistance=document.getElementById('fDistance');
  const chkFree=document.getElementById('fFreeCancel');
  const lblPrice=document.getElementById('fPriceVal');
  const lblRating=document.getElementById('fRatingVal');
  const lblDistance=document.getElementById('fDistanceVal');
  const formatDistanceLabel=m=>m<1000?`${m} m`:`${(m/1000).toFixed(1)} km`;
  function updateFilterLabels(){
    const c=CURRENCIES[state.currency];
    lblPrice.textContent=`${c.sym}${(+rngPrice.value).toFixed(0)}`;
    lblRating.textContent=(+rngRating.value).toFixed(1);
    lblDistance.textContent=formatDistanceLabel(+rngDistance.value);
  }
  ;['input','change'].forEach(ev=>{
    rngPrice.addEventListener(ev,updateFilterLabels);
    rngRating.addEventListener(ev,updateFilterLabels);
    rngDistance.addEventListener(ev,updateFilterLabels);
  });

  btnApplyFilters.addEventListener('click',()=>{
    state.filters.priceMax=+rngPrice.value;
    state.filters.ratingMin=+rngRating.value;
    state.filters.distanceMax=+rngDistance.value;
    state.filters.freeCancel=chkFree.checked;
    closeFilters(); renderList(); renderMarkers();
  });
  btnResetFilters.addEventListener('click',()=>{
    rngPrice.value=1000; rngRating.value=0; rngDistance.value=10000; chkFree.checked=false;
    updateFilterLabels();
    state.filters={priceMax:null,ratingMin:0,distanceMax:null,freeCancel:false};
    renderList(); renderMarkers();
  });

  document.getElementById('btnMapList').addEventListener('click',()=>{ document.getElementById('map').scrollIntoView({behavior:'smooth'}); });

  // init
  updateFilterLabels(); syncUITexts();

  /* =========================
     Firestore (real-time)
  ========================== */
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
  import { getFirestore, collection, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

  // ‚¨áÔ∏è Replace with your Firebase project config (for panamapresident94@gmail.com)
const firebaseConfig = {
  apiKey: "AIzaSyCyb0pn2sFTEPkL0Q1ALwZaV2QILWyP_fk",
  authDomain: "stayworld-2570c.firebaseapp.com",
  projectId: "stayworld-2570c",
  storageBucket: "stayworld-2570c.firebasestorage.app",
  messagingSenderId: "272599681686",
  appId: "1:272599681686:web:33f89b66f7ee6f6f0b50b7",
  measurementId: "G-F8MXM3D7FJ"
};

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  function subscribeHotels(){
    onSnapshot(collection(db,'hotels'), (snapshot)=>{
      hotels = [];
      snapshot.forEach(doc=>hotels.push(doc.data()));

      // Optional: a document like {center:true, city:"Seoul", lat:..., lng:...}
      const centerDoc = hotels.find(h=>h.center===true);
      if(centerDoc && typeof centerDoc.lat==='number' && typeof centerDoc.lng==='number'){
        CITY_CENTER = { name:centerDoc.city||CITY_CENTER.name, lat:centerDoc.lat, lng:centerDoc.lng };
      }
      renderList(); renderMarkers();
    });
  }
  subscribeHotels();
</script>
</body>
</html>
