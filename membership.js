/* ==========================================
   STAYWORLD Membership Logic (6 tiers)
   - Tier compute: KRW (unchanged)
   - Display money: auto by selected language's currency
   - i18n: inherit text, toNext, top, downgrade note & alerts
   - Auto downgrade if no booking >= 60 days
   ========================================== */

/* -------- Currency tables -------- */
const CURRENCIES = {
  USD:{code:'USD', locale:'en-US', rate:1300},   // 1 USD = 1300 KRW
  EUR:{code:'EUR', locale:'fr-FR', rate:1400},
  KRW:{code:'KRW', locale:'ko-KR', rate:1},
  JPY:{code:'JPY', locale:'ja-JP', rate:9.0},
  CNY:{code:'CNY', locale:'zh-CN', rate:180},
  TRY:{code:'TRY', locale:'tr-TR', rate:33},
  RUB:{code:'RUB', locale:'ru-RU', rate:90},
  GBP:{code:'GBP', locale:'en-GB', rate:1700},
  AED:{code:'AED', locale:'ar-AE', rate:355},
  CAD:{code:'CAD', locale:'en-CA', rate:970},
};

const LANG_TO_CUR = {
  EN:'USD',    // default
  KO:'KRW',
  JA:'JPY',
  ZH:'CNY',
  FR:'EUR',
  ES:'EUR',
  DE:'EUR',
  IT:'EUR',
  TR:'TRY',
  RU:'RUB',
  AR:'AED',
};

/* Money formatters (KRW source ‚Üí target currency by lang) */
function getLangCode(){
  const v = (document.getElementById('lang')?.value
          || document.getElementById('langSelect')?.value
          || localStorage.getItem('sw_lang') || 'EN').toUpperCase();
  return v.length>2 ? v.slice(0,2) : v; // normalize to 2 letters
}
function getCurrencyForLang(lang2){
  const cur = CURRENCIES[ LANG_TO_CUR[lang2] || 'USD' ];
  return cur || CURRENCIES.USD;
}
/** KRW ‚Üí display currency number */
function krwToDisplay(krw, lang2){
  const cur = getCurrencyForLang(lang2);
  return krw / (cur.rate || 1);
}
function fmtMoneyKRWtoDisplay(krw, lang2){
  const cur = getCurrencyForLang(lang2);
  const val = krwToDisplay(krw, lang2);
  // KRW/JPYÎäî 0ÏûêÎ¶¨, Í∑∏ Ïô∏ÎèÑ ÌöåÏõê Îì±Í∏â ÏûÑÍ≥ÑÍ∞íÏùÄ 0ÏûêÎ¶¨ ÌëúÍ∏∞Î°ú ÌÜµÏùº
  const maxFrac = 0;
  return new Intl.NumberFormat(cur.locale, { style:'currency', currency:cur.code, maximumFractionDigits:maxFrac }).format(val);
}

/* -------- CONFIG -------- */
const LEVELS = [
  { name:'Bronze',   min:       0, rate: 0  },
  { name:'Silver',   min:  500_000, rate: 3  },
  { name:'Gold',     min:2_000_000, rate: 5  },
  { name:'Platinum', min:4_000_000, rate: 7  },
  { name:'Diamond',  min:7_500_000, rate:10  },
  { name:'Elite',    min:15_000_000, rate:15, manual:true }
];
const DOWNGRADE_DAYS = 60;

/* -------- i18n (10Í∞ú Ïñ∏Ïñ¥) -------- */
const T = {
  EN:{
    inherit:'Upper tiers include all benefits of lower tiers.',
    your:'Your Tier',
    toNext:(rem,lang)=>`${fmtMoneyKRWtoDisplay(rem,lang)} to next tier. Auto-downgrade after 60 days of no bookings.`,
    top:'Top tier (Elite). Auto-downgrade by 1 level after 60 days of no bookings.',
    note:(days)=>`If there is no booking for ${days} days, your tier will auto-downgrade by 1 level.`,
    d30:'üì¢ Auto downgrade in 30 days. Keep your tier by booking.',
    d15:'‚ö†Ô∏è Auto downgrade in 15 days. Stay active.',
    d7 :'‚è≥ Auto downgrade in 7 days. Book soon!',
    d1 :'üö® Auto downgrade tomorrow! Complete a booking today.'
  },
  KO:{
    inherit:'ÏÉÅÏúÑ Îì±Í∏âÏùÄ ÌïòÏúÑ Îì±Í∏âÏùò Î™®Îì† ÌòúÌÉùÏùÑ Ìè¨Ìï®Ìï©ÎãàÎã§.',
    your:'ÎÇ¥ Îì±Í∏â',
    toNext:(rem,lang)=>`Îã§Ïùå Îì±Í∏âÍπåÏßÄ ${fmtMoneyKRWtoDisplay(rem,lang)} ÎÇ®ÏïòÏñ¥Ïöî. 60Ïùº ÏòàÏïΩ ÏóÜÏúºÎ©¥ ÏûêÎèô 1Îã®Í≥Ñ Í∞ïÎì±.`,
    top:'ÏµúÏÉÅÏúÑ Îì±Í∏â(Elite). 60Ïùº ÏòàÏïΩ ÏóÜÏúºÎ©¥ ÏûêÎèô 1Îã®Í≥Ñ Í∞ïÎì±.',
    note:(days)=>`ÏòàÏïΩÏù¥ ${days}Ïùº ÎèôÏïà ÏóÜÏúºÎ©¥ Îì±Í∏âÏù¥ 1Îã®Í≥Ñ ÏûêÎèô Í∞ïÎì±Îê©ÎãàÎã§.`,
    d30:'üì¢ 30Ïùº ÌõÑ ÏûêÎèô Í∞ïÎì± ÏòàÏ†ïÏûÖÎãàÎã§. ÏßÄÍ∏à ÏòàÏïΩÌïòÎ©¥ Ïú†ÏßÄÎê©ÎãàÎã§.',
    d15:'‚ö†Ô∏è 15Ïùº ÌõÑ ÏûêÎèô Í∞ïÎì± ÏòàÏ†ïÏûÖÎãàÎã§. ÌôúÎèôÏùÑ Ïú†ÏßÄÌïòÏÑ∏Ïöî.',
    d7 :'‚è≥ 7Ïùº ÌõÑ ÏûêÎèô Í∞ïÎì± ÏòàÏ†ïÏûÖÎãàÎã§. ÏÑúÎëòÎü¨ ÏòàÏïΩÌïòÏÑ∏Ïöî!',
    d1 :'üö® ÎÇ¥Ïùº ÏûêÎèô Í∞ïÎì±Îê©ÎãàÎã§! Ïò§Îäò ÏòàÏïΩÏùÑ ÏôÑÎ£åÌïòÏÑ∏Ïöî.'
  },
  JA:{
    inherit:'‰∏ä‰Ωç„ÉÜ„Ç£„Ç¢„Å´„ÅØ‰∏ã‰Ωç„ÉÜ„Ç£„Ç¢„ÅÆÁâπÂÖ∏„Åå„Åô„Åπ„Å¶Âê´„Åæ„Çå„Åæ„Åô„ÄÇ',
    your:'„ÅÇ„Å™„Åü„ÅÆ„ÉÜ„Ç£„Ç¢',
    toNext:(rem,lang)=>`Ê¨°„ÅÆ„ÉÜ„Ç£„Ç¢„Åæ„Åß ${fmtMoneyKRWtoDisplay(rem,lang)}„ÄÇ60Êó•‰∫àÁ¥Ñ„Åå„Å™„ÅÑÂ†¥Âêà„ÅØËá™Âãï„Åß1ÊÆµÈöéÈôçÊ†º„ÄÇ`,
    top:'ÊúÄ‰∏ä‰ΩçÔºàEliteÔºâ„ÄÇ60Êó•‰∫àÁ¥Ñ„Åå„Å™„ÅÑÂ†¥Âêà„ÅØËá™Âãï„Åß1ÊÆµÈöéÈôçÊ†º„ÄÇ',
    note:(d)=>`${d}Êó•Èñì‰∫àÁ¥Ñ„Åå„Å™„ÅÑÂ†¥Âêà„ÄÅ„ÉÜ„Ç£„Ç¢„ÅØ1ÊÆµÈöéËá™ÂãïÈôçÊ†º„Åó„Åæ„Åô„ÄÇ`,
    d30:'üì¢ 30Êó•Âæå„Å´Ëá™ÂãïÈôçÊ†º„Åó„Åæ„Åô„ÄÇ‰∫àÁ¥Ñ„ÅßÁ∂≠ÊåÅ„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ',
    d15:'‚ö†Ô∏è 15Êó•Âæå„Å´Ëá™ÂãïÈôçÊ†º„Åó„Åæ„Åô„ÄÇ„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å´ÔºÅ',
    d7 :'‚è≥ 7Êó•Âæå„Å´Ëá™ÂãïÈôçÊ†º„Åó„Åæ„Åô„ÄÇ„ÅäÊó©„ÇÅ„Å´‰∫àÁ¥Ñ„ÇíÔºÅ',
    d1 :'üö® ÊòéÊó•Ëá™ÂãïÈôçÊ†ºÔºÅÊú¨Êó•‰∏≠„Å´‰∫àÁ¥Ñ„ÇíÂÆå‰∫Ü„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'
  },
  ZH:{
    inherit:'È´òÁ≠âÁ∫ßÂåÖÂê´ÊâÄÊúâ‰ΩéÁ≠âÁ∫ßÁöÑÊùÉÁõä„ÄÇ',
    your:'ÊÇ®ÁöÑÁ≠âÁ∫ß',
    toNext:(rem,lang)=>`Ë∑ùÁ¶ª‰∏ã‰∏ÄÁ≠âÁ∫ßËøòÂ∑Æ ${fmtMoneyKRWtoDisplay(rem,lang)}„ÄÇËã•ËøûÁª≠60Â§©Êú™È¢ÑËÆ¢Â∞ÜËá™Âä®Èôç‰∏ÄÁ∫ß„ÄÇ`,
    top:'ÊúÄÈ´òÁ≠âÁ∫ßÔºàEliteÔºâ„ÄÇËã•ËøûÁª≠60Â§©Êú™È¢ÑËÆ¢Â∞ÜËá™Âä®Èôç‰∏ÄÁ∫ß„ÄÇ',
    note:(d)=>`Ëã•${d}Â§©ÂÜÖÊ≤°ÊúâÈ¢ÑËÆ¢ÔºåÊÇ®ÁöÑÁ≠âÁ∫ßÂ∞ÜËá™Âä®Èôç‰Ωé‰∏ÄÁ∫ß„ÄÇ`,
    d30:'üì¢ 30Â§©ÂêéÂ∞ÜËá™Âä®ÈôçÁ∫ß„ÄÇÂ∞ΩÂø´È¢ÑËÆ¢‰ª•‰øùÊåÅÁ≠âÁ∫ß„ÄÇ',
    d15:'‚ö†Ô∏è 15Â§©ÂêéÂ∞ÜËá™Âä®ÈôçÁ∫ß„ÄÇËØ∑‰øùÊåÅÊ¥ªË∑É„ÄÇ',
    d7 :'‚è≥ 7Â§©ÂêéÂ∞ÜËá™Âä®ÈôçÁ∫ß„ÄÇÂ∞ΩÂø´È¢ÑËÆ¢ÔºÅ',
    d1 :'üö® ÊòéÂ§©Â∞ÜËá™Âä®ÈôçÁ∫ßÔºÅËØ∑‰ªäÂ§©ÂÆåÊàêÈ¢ÑËÆ¢„ÄÇ'
  },
  FR:{
    inherit:'Les niveaux sup√©rieurs incluent tous les avantages des niveaux inf√©rieurs.',
    your:'Votre niveau',
    toNext:(rem,lang)=>`${fmtMoneyKRWtoDisplay(rem,lang)} pour atteindre le prochain niveau. R√©trogradation automatique apr√®s 60 jours sans r√©servation.`,
    top:'Niveau maximal (Elite). R√©trogradation d‚Äôun niveau apr√®s 60 jours sans r√©servation.',
    note:(d)=>`S‚Äôil n‚Äôy a aucune r√©servation pendant ${d} jours, votre niveau sera r√©trograd√© d‚Äôun cran.`,
    d30:'üì¢ R√©trogradation dans 30 jours. Conservez votre niveau en r√©servant.',
    d15:'‚ö†Ô∏è R√©trogradation dans 15 jours. Restez actif.',
    d7 :'‚è≥ R√©trogradation dans 7 jours. R√©servez vite !',
    d1 :'üö® R√©trogradation demain ! Finalisez une r√©servation d√®s aujourd‚Äôhui.'
  },
  ES:{
    inherit:'Los niveles superiores incluyen todos los beneficios de los inferiores.',
    your:'Tu nivel',
    toNext:(rem,lang)=>`${fmtMoneyKRWtoDisplay(rem,lang)} para el siguiente nivel. Degradaci√≥n autom√°tica tras 60 d√≠as sin reservas.`,
    top:'Nivel m√°s alto (Elite). Degradaci√≥n autom√°tica de 1 nivel tras 60 d√≠as sin reservas.',
    note:(d)=>`Si no hay reservas durante ${d} d√≠as, tu nivel bajar√° 1 nivel autom√°ticamente.`,
    d30:'üì¢ Degradaci√≥n en 30 d√≠as. Mant√©n tu nivel reservando.',
    d15:'‚ö†Ô∏è Degradaci√≥n en 15 d√≠as. Mantente activo.',
    d7 :'‚è≥ Degradaci√≥n en 7 d√≠as. ¬°Reserva pronto!',
    d1 :'üö® ¬°Ma√±ana se degrada! Completa una reserva hoy.'
  },
  DE:{
    inherit:'H√∂here Stufen beinhalten alle Vorteile der niedrigeren.',
    your:'Deine Stufe',
    toNext:(rem,lang)=>`${fmtMoneyKRWtoDisplay(rem,lang)} bis zur n√§chsten Stufe. Automatische Herabstufung nach 60 Tagen ohne Buchung.`,
    top:'H√∂chste Stufe (Elite). Herabstufung um 1 Stufe nach 60 Tagen ohne Buchung.',
    note:(d)=>`Ohne Buchung innerhalb von ${d} Tagen wird deine Stufe automatisch um 1 herabgestuft.`,
    d30:'üì¢ Herabstufung in 30 Tagen. Stufe durch Buchung sichern.',
    d15:'‚ö†Ô∏è Herabstufung in 15 Tagen. Aktiv bleiben.',
    d7 :'‚è≥ Herabstufung in 7 Tagen. Bald buchen!',
    d1 :'üö® Morgen Herabstufung! Heute buchen.'
  },
  IT:{
    inherit:'I livelli superiori includono tutti i vantaggi dei livelli inferiori.',
    your:'Il tuo livello',
    toNext:(rem,lang)=>`${fmtMoneyKRWtoDisplay(rem,lang)} al prossimo livello. Retrocessione automatica dopo 60 giorni senza prenotazioni.`,
    top:'Livello massimo (Elite). Retrocessione di 1 livello dopo 60 giorni senza prenotazioni.',
    note:(d)=>`Se non ci sono prenotazioni per ${d} giorni, il livello verr√† retrocesso di 1.`,
    d30:'üì¢ Retrocessione tra 30 giorni. Mantieni il livello prenotando.',
    d15:'‚ö†Ô∏è Retrocessione tra 15 giorni. Rimani attivo.',
    d7 :'‚è≥ Retrocessione tra 7 giorni. Prenota presto!',
    d1 :'üö® Retrocessione domani! Completa una prenotazione oggi.'
  },
  TR:{
    inherit:'√úst seviyeler, alt seviyelerin t√ºm avantajlarƒ±nƒ± i√ßerir.',
    your:'Seviyen',
    toNext:(rem,lang)=>`Sonraki seviyeye ${fmtMoneyKRWtoDisplay(rem,lang)} kaldƒ±. 60 g√ºn rezervasyon yoksa otomatik 1 seviye d√º≈üer.`,
    top:'En √ºst seviye (Elite). 60 g√ºn rezervasyon yoksa 1 seviye d√º≈ü√ºr√ºl√ºr.',
    note:(d)=>`${d} g√ºn rezervasyon olmazsa, seviyen otomatik olarak 1 d√º≈üer.`,
    d30:'üì¢ 30 g√ºn i√ßinde seviye d√º≈ü√ºr√ºlecek. Rezervasyonla koru.',
    d15:'‚ö†Ô∏è 15 g√ºn i√ßinde seviye d√º≈ü√ºr√ºlecek. Aktif kal.',
    d7 :'‚è≥ 7 g√ºn i√ßinde seviye d√º≈ü√ºr√ºlecek. Yakƒ±nda rezervasyon yap!',
    d1 :'üö® Yarƒ±n seviye d√º≈ü√ºr√ºlecek! Bug√ºn rezervasyonu tamamla.'
  },
  RU:{
    inherit:'–í—ã—Å—à–∏–µ —É—Ä–æ–≤–Ω–∏ –≤–∫–ª—é—á–∞—é—Ç –≤—Å–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–∏–∂–Ω–∏—Ö.',
    your:'–í–∞—à —É—Ä–æ–≤–µ–Ω—å',
    toNext:(rem,lang)=>`${fmtMoneyKRWtoDisplay(rem,lang)} –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è. –ê–≤—Ç–æ–ø–æ–Ω–∏–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 60 –¥–Ω–µ–π –±–µ–∑ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π.`,
    top:'–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å (Elite). –ü–æ–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞ 1 —É—Ä–æ–≤–µ–Ω—å —á–µ—Ä–µ–∑ 60 –¥–Ω–µ–π –±–µ–∑ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π.',
    note:(d)=>`–ï—Å–ª–∏ –Ω–µ—Ç –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π ${d} –¥–Ω–µ–π, –≤–∞—à —É—Ä–æ–≤–µ–Ω—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–Ω–∏–∑–∏—Ç—Å—è –Ω–∞ 1.`,
    d30:'üì¢ –ü–æ–Ω–∏–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 30 –¥–Ω–µ–π. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å, –æ—Ñ–æ—Ä–º–∏–≤ –±—Ä–æ–Ω—å.',
    d15:'‚ö†Ô∏è –ü–æ–Ω–∏–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 15 –¥–Ω–µ–π. –û—Å—Ç–∞–≤–∞–π—Ç–µ—Å—å –∞–∫—Ç–∏–≤–Ω—ã–º–∏.',
    d7 :'‚è≥ –ü–æ–Ω–∏–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 7 –¥–Ω–µ–π. –ó–∞–±—Ä–æ–Ω–∏—Ä—É–π—Ç–µ —Å–∫–æ—Ä–æ!',
    d1 :'üö® –ü–æ–Ω–∏–∂–µ–Ω–∏–µ –∑–∞–≤—Ç—Ä–∞! –ó–∞–≤–µ—Ä—à–∏—Ç–µ –±—Ä–æ–Ω—å —Å–µ–≥–æ–¥–Ω—è.'
  },
  AR:{
    inherit:'ÿ™ÿ¥ŸÖŸÑ ÿßŸÑŸÖÿ≥ÿ™ŸàŸäÿßÿ™ ÿßŸÑÿ£ÿπŸÑŸâ ÿ¨ŸÖŸäÿπ ŸÖÿ≤ÿßŸäÿß ÿßŸÑŸÖÿ≥ÿ™ŸàŸäÿßÿ™ ÿßŸÑÿ£ÿØŸÜŸâ.',
    your:'ŸÖÿ≥ÿ™ŸàÿßŸÉ',
    toNext:(rem,lang)=>`${fmtMoneyKRWtoDisplay(rem,lang)} ŸÑŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸâ ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿ™ÿßŸÑŸä. ÿ≥Ÿäÿ™ŸÖ ÿÆŸÅÿ∂ ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ ÿ™ŸÑŸÇÿßÿ¶ŸäŸãÿß ÿ®ÿπÿØ 60 ŸäŸàŸÖŸãÿß ÿØŸàŸÜ ÿ≠ÿ¨ÿ≤.`,
    top:'ÿ£ÿπŸÑŸâ ŸÖÿ≥ÿ™ŸàŸâ (Elite). Ÿäÿ™ŸÖ ÿßŸÑÿÆŸÅÿ∂ ÿ®ŸÖÿ≥ÿ™ŸàŸâ Ÿàÿßÿ≠ÿØ ÿ®ÿπÿØ 60 ŸäŸàŸÖŸãÿß ÿØŸàŸÜ ÿ≠ÿ¨ÿ≤.',
    note:(d)=>`ÿ•ÿ∞ÿß ŸÑŸÖ Ÿäÿ™ŸÖ ÿ•ÿ¨ÿ±ÿßÿ° ÿ≠ÿ¨ÿ≤ ŸÑŸÖÿØÿ© ${d} ŸäŸàŸÖŸãÿßÿå ÿ≥Ÿäÿ™ŸÖ ÿÆŸÅÿ∂ ŸÖÿ≥ÿ™ŸàÿßŸÉ ÿ™ŸÑŸÇÿßÿ¶ŸäŸãÿß ŸÖÿ≥ÿ™ŸàŸâ Ÿàÿßÿ≠ÿØŸãÿß.`,
    d30:'üì¢ ÿ≥Ÿäÿ™ŸÖ ÿßŸÑÿÆŸÅÿ∂ ÿÆŸÑÿßŸÑ 30 ŸäŸàŸÖŸãÿß. ÿßÿ≠ŸÅÿ∏ ŸÖÿ≥ÿ™ŸàÿßŸÉ ÿ®ÿßŸÑÿ≠ÿ¨ÿ≤.',
    d15:'‚ö†Ô∏è ÿ≥Ÿäÿ™ŸÖ ÿßŸÑÿÆŸÅÿ∂ ÿÆŸÑÿßŸÑ 15 ŸäŸàŸÖŸãÿß. ÿßÿ®ŸÇŸé ŸÜÿ¥ÿ∑Ÿãÿß.',
    d7 :'‚è≥ ÿ≥Ÿäÿ™ŸÖ ÿßŸÑÿÆŸÅÿ∂ ÿÆŸÑÿßŸÑ 7 ÿ£ŸäÿßŸÖ. ÿ≥ÿßÿ±ÿπ ÿ®ÿßŸÑÿ≠ÿ¨ÿ≤!',
    d1 :'üö® ÿ≥Ÿäÿ™ŸÖ ÿßŸÑÿÆŸÅÿ∂ ÿ∫ÿØŸãÿß! ÿ£ŸÉŸÖŸêŸÑ ÿ≠ÿ¨ÿ≤ŸÉ ÿßŸÑŸäŸàŸÖ.'
  },
};

/* -------- Benefits (inherit) -------- */
const BENEFITS = {
  EN:{
    Bronze:[['üõ°Ô∏è','Basic support'],['üí≥','Secure card/crypto payments']],
    Silver:[['üéÅ','Welcome coupon'],['üìû','Priority email support (business hours)']],
    Gold:[['üí∏','5% rewards back'],['‚è∞','Late checkout when available']],
    Platinum:[['üöó','Airport shuttle partner discounts'],['üßæ','Business invoice support (B2B)']],
    Diamond:[['üíº','Dedicated concierge (chat)'],['‚¨ÜÔ∏è','Complimentary upgrade when available']],
    Elite:[['üëë','Invite-only experiences & VIP support']]
  },
  KO:{
    Bronze:[['üõ°Ô∏è','Í∏∞Î≥∏ Í≥†Í∞ùÏßÄÏõê'],['üí≥','ÏïàÏ†ÑÌïú Ïπ¥Îìú/ÌÅ¨Î¶ΩÌÜ† Í≤∞Ï†ú']],
    Silver:[['üéÅ','Ïõ∞Ïª¥ Ïø†Ìè∞'],['üìû','Ïö∞ÏÑ† Ïù¥Î©îÏùº ÏùëÎåÄ(ÏòÅÏóÖÏãúÍ∞Ñ)']],
    Gold:[['üí∏','Î¶¨ÏõåÏ¶à 5% Ï†ÅÎ¶Ω'],['‚è∞','Í∞ÄÎä• Ïãú Î†àÏù¥Ìä∏ Ï≤¥ÌÅ¨ÏïÑÏõÉ']],
    Platinum:[['üöó','Í≥µÌï≠ ÏÖîÌãÄ Ï†úÌú¥ Ìï†Ïù∏'],['üßæ','B2B ÏÑ∏Í∏àÍ≥ÑÏÇ∞ÏÑú ÏßÄÏõê']],
    Diamond:[['üíº','Ï†ÑÎã¥ Ïª®ÏãúÏñ¥ÏßÄ(Ï±ÑÌåÖ)'],['‚¨ÜÔ∏è','Í∞ÄÎä• Ïãú Î¨¥Î£å ÏóÖÍ∑∏Î†àÏù¥Îìú']],
    Elite:[['üëë','Ï¥àÏ≤≠Ìòï Í≤ΩÌóò & VIP ÏßÄÏõê']]
  }
};
function benefitList(lang2, tier){
  const lang = BENEFITS[lang2] ? lang2 : 'EN';
  const order = ['Bronze','Silver','Gold','Platinum','Diamond','Elite'];
  const idx = order.indexOf(tier);
  const acc = [];
  for(let i=0;i<=idx;i++){
    (BENEFITS[lang][order[i]] || []).forEach(b=> acc.push(b));
  }
  return acc;
}

/* -------- Helpers -------- */
function $(s,sc){return (sc||document).querySelector(s);}
function $all(s,sc){return (sc||document).querySelectorAll(s);}

/* -------- Level compute (KRW) -------- */
function computeLevel(totalSpentKRW, lastBookingISO){
  let base = 0;
  for (let i=0;i<LEVELS.length;i++){
    if (totalSpentKRW >= LEVELS[i].min) base = i;
  }
  if (lastBookingISO){
    const diffDays = Math.floor((Date.now()-new Date(lastBookingISO).getTime())/86400000);
    if (diffDays >= DOWNGRADE_DAYS) base = Math.max(0, base-1);
  }
  return base;
}
function remainingToNext(totalSpentKRW, levelIdx){
  if (levelIdx >= LEVELS.length-1) return null;
  return Math.max(0, LEVELS[levelIdx+1].min - totalSpentKRW);
}

/* -------- UI -------- */
function applyLevelUI(levelIdx, totalSpentKRW){
  const lang2 = getLangCode();
  const L = T[lang2] || T.EN;

  $('#inheritNote')?.textContent = L.inherit;
  $('#levelTitle')?.textContent  = L.your;

  const rem = remainingToNext(totalSpentKRW, levelIdx);
  const txt = $('#levelProgressText');
  let pct = 100;
  if (rem !== null){
    const curr = LEVELS[levelIdx].min;
    const next = LEVELS[levelIdx+1].min;
    pct = Math.min(100, Math.max(0, Math.round(((totalSpentKRW-curr)/(next-curr))*100)));
    if (txt) txt.textContent = L.toNext(rem, lang2);
  } else {
    if (txt) txt.textContent = L.top;
  }
  const gauge = document.querySelector('.card .bg-[var(--gold)].h-2')
             || $all('.w-full.bg-white\\/10.rounded-full.h-2')[0]?.querySelector('.h-2');
  const pctEl = $('.text-right.text-xs.text-white\\/60.mt-1');
  if (gauge) gauge.style.width = pct+'%';
  if (pctEl) pctEl.textContent = pct+'%';

  const order = ['Bronze','Silver','Gold','Platinum','Diamond','Elite'];
  $all('#tiersGrid [data-tier]').forEach(card=>{
    const name = card.getAttribute('data-tier');
    const idx  = order.indexOf(name);
    card.classList.toggle('tier-active', idx===levelIdx);
    card.classList.toggle('tier-muted',  idx>levelIdx);

    const wrap = card.querySelector('.benefits');
    if (wrap){
      wrap.innerHTML = '';
      benefitList(lang2, name).forEach(([icon, text])=>{
        const el = document.createElement('div');
        el.className = 'benefit';
        el.innerHTML = `<i>${icon}</i><span>${text}</span>`;
        wrap.appendChild(el);
      });
      // ÏäπÍ∏â Í∏∞Ï§Ä(Ïñ∏Ïñ¥Î≥Ñ ÌÜµÌôîÎ°ú ÌëúÏãú)
      const guide = document.createElement('div');
      guide.className = 'note'; guide.style.marginTop='6px';
      const msg = lang2==='KO' ? `ÏäπÍ∏â Í∏∞Ï§Ä: ${fmtMoneyKRWtoDisplay(LEVELS[idx].min, lang2)} Ïù¥ÏÉÅ ÎàÑÏ†Å Í≤∞Ï†ú`
                               : `Upgrade threshold: ${fmtMoneyKRWtoDisplay(LEVELS[idx].min, lang2)} total spent`;
      guide.textContent = msg;
      wrap.appendChild(guide);
    }
  });

  $('#downgradeNote')?.textContent = (T[lang2]||T.EN).note(DOWNGRADE_DAYS);
}

/* -------- Alerts -------- */
function showDowngradeAlert(daysLeft){
  const lang2=getLangCode(), L=T[lang2]||T.EN;
  const map={30:L.d30,15:L.d15,7:L.d7,1:L.d1};
  const msg=map[daysLeft]; if(!msg) return;
  const el=document.createElement('div');
  el.className="fixed bottom-5 right-5 bg-red-600 text-white px-4 py-3 rounded-xl shadow-lg z-50";
  el.textContent=msg; document.body.appendChild(el);
  setTimeout(()=>el.remove(),8000);
}

/* -------- Public API -------- */
function setUserContext({ totalSpentKRW, lastBookingISO }){
  const idx = computeLevel(totalSpentKRW, lastBookingISO);
  applyLevelUI(idx, totalSpentKRW);
  if (lastBookingISO){
    const d = Math.floor((Date.now()-new Date(lastBookingISO).getTime())/86400000);
    const left = DOWNGRADE_DAYS - d;
    if ([30,15,7,1].includes(left)) showDowngradeAlert(left);
  }
}
window.setUserContext = setUserContext;

/* Re-apply when language changes on this page */
document.addEventListener('change', (e)=>{
  if (e.target && (e.target.id==='lang' || e.target.id==='langSelect')){
    // Ïú†ÏßÄ: ÏµúÍ∑º Ï†ÄÏû•Îêú ÏÇ¨Ïö©Ïûê Í∞íÏúºÎ°ú Îã§Ïãú Í∑∏Î¶¨Í∏∞
    let u = {};
    try{ u = JSON.parse(localStorage.getItem('sw_user')||'{}'); }catch(_){}
    setUserContext({
      totalSpentKRW: Number.isFinite(u.totalSpentKRW)?u.totalSpentKRW:0,
      lastBookingISO: u.lastBookingISO||null
    });
  }
});
