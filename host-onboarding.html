<!doctype html>
<html lang="ko" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>StayWorld â€” Become a Host</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .grid-preview img{ aspect-ratio:1/1; object-fit:cover; }
    .progress{height:6px}
  </style>
</head>
<body class="bg-[#0b0f16] text-white min-h-screen">
  <header class="sticky top-0 z-30 backdrop-blur bg-black/40 border-b border-white/10">
    <div class="max-w-4xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="/mypage.html" class="text-emerald-300 hover:underline text-sm">â† Back to My Page</a>
      <div class="font-semibold">ğŸŒŸ Become a Host</div>
      <div></div>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-4 py-8">
    <section class="rounded-2xl border border-white/10 bg-white/5 p-6">
      <h1 class="text-2xl font-bold">í˜¸ìŠ¤íŠ¸ ì „í™˜ ì‹ ì²­</h1>
      <p class="text-white/70 text-sm mt-2">
        ì•„ë˜ ì •ë³´ë¥¼ ì…ë ¥í•˜ê³  <b>ì‹ ë¶„ì¦ ë˜ëŠ” ì—¬ê¶Œ</b>ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.
        <b class="text-emerald-300">ìµœì†Œ 1ì¥</b>ì€ ë°˜ë“œì‹œ ì—…ë¡œë“œë˜ì–´ì•¼ í•˜ë©°,
        <b>ì—…ë¡œë“œ ìˆ˜ì—ëŠ” ì œí•œì´ ì—†ìŠµë‹ˆë‹¤.</b> ì œì¶œ ì¦‰ì‹œ í˜¸ìŠ¤íŠ¸ ëª¨ë“œê°€ í™œì„±í™”ë©ë‹ˆë‹¤.
      </p>

      <form id="form" class="mt-6 grid gap-4">
        <div>
          <label class="block text-sm">ì„±ëª…(ë²•ì  ì´ë¦„) *</label>
          <input id="fullname" class="w-full mt-1 px-3 py-2 rounded-xl bg-white/10 border border-white/10" required>
        </div>
        <div>
          <label class="block text-sm">ì „í™”ë²ˆí˜¸ *</label>
          <input id="phone" class="w-full mt-1 px-3 py-2 rounded-xl bg-white/10 border border-white/10" required>
        </div>

        <div>
          <label class="block text-sm">ì‹ ë¶„ì¦/ì—¬ê¶Œ íŒŒì¼ ì—…ë¡œë“œ (ì´ë¯¸ì§€ ë˜ëŠ” PDF) *</label>
          <input id="files" type="file" accept="image/*,application/pdf" multiple class="mt-1 w-full" required>
          <div id="hint" class="text-white/50 text-xs mt-1">
            ìµœì†Œ 1ì¥ í•„ìˆ˜, ê°œìˆ˜ ì œí•œ ì—†ìŒ. (ì˜ˆ: ì•/ë’¤, ì—¬ê¶Œ, ì…€í”¼ ë“±)
          </div>
          <div id="preview" class="grid grid-cols-3 gap-2 mt-2 grid-preview"></div>
        </div>

        <div class="progress w-full rounded bg-white/10 overflow-hidden hidden" id="barWrap">
          <div id="bar" class="bg-emerald-400" style="width:0%"></div>
        </div>

        <div class="flex justify-end">
          <button id="submitBtn" class="px-4 py-2 rounded-xl bg-white text-black font-semibold">
            í˜¸ìŠ¤íŠ¸ ëª¨ë“œ í™œì„±í™”
          </button>
        </div>
      </form>

      <p id="status" class="mt-4 text-white/70"></p>
    </section>
  </main>

  <script type="module">
    import {
      auth, onAuthStateChanged,
      db, storage,
      doc, getDoc, setDoc,
      ref, uploadBytes, getDownloadURL
    } from '/scripts/firebase.js';

    let currentUser = null;

    onAuthStateChanged(auth, async (u)=>{
      if (!u) return location.href='/login.html';
      currentUser = u;

      // ì´ë¯¸ í˜¸ìŠ¤íŠ¸ë©´ ë°”ë¡œ ëŒ€ì‹œë³´ë“œë¡œ
      const us = await getDoc(doc(db,'users',u.uid));
      if (us.exists() && (us.data().role === 'host')) {
        const hs = await getDoc(doc(db,'hosts',u.uid));
        if (hs.exists()) return location.href='/host-dashboard.html';
      }
    });

    // ë¯¸ë¦¬ë³´ê¸°
    const filesEl = document.getElementById('files');
    const hintEl = document.getElementById('hint');
    const previewEl = document.getElementById('preview');
    const barWrap = document.getElementById('barWrap');
    const bar = document.getElementById('bar');
    const submitBtn = document.getElementById('submitBtn');
    const statusEl = document.getElementById('status');

    filesEl.addEventListener('change', ()=>{
      previewEl.innerHTML = '';
      const files = [...filesEl.files];
      files.forEach((f,i)=>{
        const card = document.createElement('div');
        card.className = 'rounded-xl border border-white/10 bg-white/5 p-1';
        if (f.type.startsWith('image/')){
          const img = document.createElement('img');
          img.src = URL.createObjectURL(f);
          img.className = 'w-full h-24 rounded-lg';
          card.appendChild(img);
        }else{
          card.innerHTML = `<div class="h-24 grid place-items-center text-xs text-white/70">PDF ${i+1}</div>`;
        }
        previewEl.appendChild(card);
      });
      hintEl.textContent = files.length ? `ì„ íƒë¨: ${files.length}ê°œ` : 'ìµœì†Œ 1ì¥ ì´ìƒ ì—…ë¡œë“œí•´ì•¼ í•©ë‹ˆë‹¤.';
      submitBtn.disabled = files.length < 1;
    });

    // ì œì¶œ
    document.getElementById('form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      if (!currentUser) return;

      const files = [...filesEl.files];
      if (files.length < 1) { alert('ìµœì†Œ 1ì¥ ì—…ë¡œë“œê°€ í•„ìš”í•©ë‹ˆë‹¤.'); return; }

      const fullname = document.getElementById('fullname').value.trim();
      const phone = document.getElementById('phone').value.trim();
      if (!fullname || !phone) return;

      try{
        submitBtn.disabled = true;
        barWrap.classList.remove('hidden');
        bar.style.width = '0%';

        // 1) íŒŒì¼ ì—…ë¡œë“œ (ì—¬ëŸ¬ ì¥)
        const urls = [];
        for (let i=0; i<files.length; i++){
          const f = files[i];
          const path = `ids/${currentUser.uid}/${Date.now()}-${i+1}-${f.name}`;
          const sref = ref(storage, path);
          await uploadBytes(sref, f);
          const url = await getDownloadURL(sref);
          urls.push(url);
          bar.style.width = `${Math.round(((i+1)/files.length)*100)}%`;
        }

        // 2) hosts ë¬¸ì„œ ì €ì¥ (ë°”ë¡œ í™œì„±í™”ìš© verified:true)
        await setDoc(doc(db,'hosts', currentUser.uid), {
          uid: currentUser.uid,
          name: fullname,
          phone,
          idUrls: urls,
          verified: true,          // âœ… ê´€ë¦¬ì ìŠ¹ì¸ ì—†ì´ ë°”ë¡œ í™œì„±í™”
          submittedAt: Date.now()
        }, { merge:true });

        // 3) users.role = 'host' ë¡œ ì „í™˜(ë³‘í•©)
        await setDoc(doc(db,'users', currentUser.uid), { role: 'host', name: fullname }, { merge:true });

        statusEl.textContent = 'âœ… í˜¸ìŠ¤íŠ¸ ëª¨ë“œê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ëŒ€ì‹œë³´ë“œë¡œ ì´ë™í•©ë‹ˆë‹¤â€¦';
        setTimeout(()=> location.href='/host-dashboard.html', 600);
      }catch(err){
        console.error(err);
        alert('ì²˜ë¦¬ ì‹¤íŒ¨: ' + err.message);
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
