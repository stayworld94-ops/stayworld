<!doctype html>
<html lang="en" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>StayWorld — Login</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#0b0f16] text-white min-h-screen grid place-items-center p-6">
  <div class="w-full max-w-md rounded-2xl border border-white/10 bg-white/5 p-6">
    <h1 class="text-2xl font-bold">Welcome back</h1>
    <p class="text-white/60 text-sm">Log in to manage your stays.</p>

    <!-- 로딩 스피너 -->
    <div id="loading" class="flex items-center gap-2 text-white/70 mt-6">
      <svg class="animate-spin h-5 w-5" viewBox="0 0 24 24" fill="none">
        <circle class="opacity-20" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
        <path class="opacity-80" d="M22 12a10 10 0 0 1-10 10" stroke="currentColor" stroke-width="4" stroke-linecap="round"/>
      </svg>
      Checking session…
    </div>

    <form id="loginForm" class="mt-6 space-y-3 hidden">
      <input id="email" type="email" placeholder="Email" class="w-full px-3 py-2 rounded-xl bg-white/10 border border-white/10" required>
      <input id="password" type="password" placeholder="Password" class="w-full px-3 py-2 rounded-xl bg-white/10 border border-white/10" required>
      <button class="w-full px-3 py-2 rounded-xl bg-white text-black font-semibold">Log in</button>
    </form>

    <div class="mt-4 hidden" id="googleBox">
      <button id="googleBtn" class="w-full px-3 py-2 rounded-xl bg-white text-black font-semibold flex items-center justify-center gap-2">
        <!-- Google 아이콘 -->
        <svg width="18" height="18" viewBox="0 0 48 48">
          <path fill="#FFC107" d="M43.6 20.5H42V20H24v8h11.3C33.6 32.4 29.2 36 24 36c-6.6 0-12-5.4-12-12s5.4-12 12-12c3 0 5.8 1.1 7.9 3l5.7-5.7C34.6 6.1 29.6 4 24 4 12.9 4 4 12.9 4 24s8.9 20 20 20 19.2-8.9 19.2-20c0-1.3-.1-2.2-.6-3.5z"/>
          <path fill="#FF3D00" d="M6.3 14.7l6.6 4.8C14.6 16.1 18.9 14 24 14c3 0 5.8 1.1 7.9 3l5.7-5.7C34.6 6.1 29.6 4 24 4 16.1 4 9.2 8.5 6.3 14.7z"/>
          <path fill="#4CAF50" d="M24 44c5 0 9.6-1.9 13-5.1l-6.1-5c-2 1.4-4.6 2.2-6.9 2.2-5.2 0-9.6-3.6-11.2-8.5l-6.5 5C9 39.3 16 44 24 44z"/>
          <path fill="#1976D2" d="M43.6 20.5H42V20H24v8h11.3c-1 3.1-3.5 5.6-6.4 6.9l6.1 5c3.6-3.3 5.6-8.1 5.6-13.9 0-1.3-.1-2.2-.6-3.5z"/>
        </svg>
        Continue with Google
      </button>
    </div>

    <p class="text-white/60 text-sm mt-4 hidden" id="signupLine">
      No account? <a href="/signup.html" class="text-emerald-300">Sign up</a>
    </p>
  </div>

  <!-- 공통 헤더용(이름/로그아웃/환영배너) 스크립트 -->
  <script type="module" src="/scripts/auth-ui.js"></script>

  <!-- 로그인 페이지 전용 스크립트 -->
  <script type="module">
   <script type="module">
  import {
    auth, onAuthStateChanged,
    signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup,
    db, doc, getDoc, setDoc
  } from '/scripts/firebase.js';

  const loading = document.getElementById('loading');
  const form = document.getElementById('loginForm');
  const googleBox = document.getElementById('googleBox');
  const signupLine = document.getElementById('signupLine');

  // 1) 최초 로그인 시 user 문서 보장
  async function ensureUserDoc(user){
    const uref = doc(db, 'users', user.uid);
    const usnap = await getDoc(uref);
    if (!usnap.exists()){
      await setDoc(uref, {
        uid: user.uid,
        email: user.email || '',
        name: user.displayName || '',
        role: 'guest',
        createdAt: Date.now()
      }, { merge: true });
      return { role: 'guest' };
    }
    return usnap.data();
  }

  // 2) 역할별 이동
  async function redirectAfter(user){
    try{
      const u = await ensureUserDoc(user);
      const role = u.role || 'guest';

      if (role === 'admin'){
        location.href = '/admin-dashboard.html';
        return;
      }

      if (role === 'host'){
        // 호스트 검증 체크
        const hs = await getDoc(doc(db, 'hosts', user.uid));
        const verified = hs.exists() ? !!hs.data().verified : false;
        location.href = verified ? '/host-dashboard.html' : '/host-register.html'; // 또는 '/host-onboarding.html'
        return;
      }

      // 게스트는 마이페이지로
      location.href = '/mypage.html';
    }catch(err){
      console.error('[redirectAfter]', err);
      // 문제 있으면 최소 홈으로
      location.href = '/';
    }
  }

  // 세션 상태에 따라 폼/리다이렉트 처리
  onAuthStateChanged(auth, (u)=>{
    if (u){
      loading.classList.remove('flex'); loading.classList.add('hidden');
      form.classList.add('hidden'); googleBox.classList.add('hidden'); signupLine.classList.add('hidden');
      redirectAfter(u);
    }else{
      loading.classList.add('hidden');
      form.classList.remove('hidden'); googleBox.classList.remove('hidden'); signupLine.classList.remove('hidden');
    }
  });

  // 이메일/비번 로그인
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    try{
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const cred = await signInWithEmailAndPassword(auth, email, password);
      await redirectAfter(cred.user);
    }catch(err){
      alert('로그인 실패: ' + (err.message || err.code));
      console.error(err);
    }
  });

  // 구글 로그인
  document.getElementById('googleBtn').addEventListener('click', async ()=>{
    try{
      const provider = new GoogleAuthProvider();
      const cred = await signInWithPopup(auth, provider);
      await redirectAfter(cred.user);
    }catch(err){
      alert('구글 로그인 실패: ' + (err.message || err.code));
      console.error(err);
    }
  });
</script>

  <script type="module" src="/scripts/auth-ui.js"></script>

</body>
</html>
