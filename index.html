<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>STAYWORLD ‚Äî Luxury Global Reach</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>

  <style>
    :root{--bg:#0b0f16;--panel:#101018;--text:#e7e9ee;--muted:#cfd6e6;--line:rgba(255,255,255,.08);--chip:#121a26;--gold1:#f4d78c;--gold2:#c9a35b}
    *{box-sizing:border-box}html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,sans-serif;line-height:1.5}
    a{color:inherit;text-decoration:none}.container{max-width:1120px;margin:0 auto;padding:0 16px}
    img{max-width:100%;display:block}
    .site-header{position:sticky;top:0;z-index:1000;background:rgba(11,15,22,.85);backdrop-filter:blur(8px);border-bottom:1px solid var(--line)}
    .header-row{display:flex;align-items:center;justify-content:space-between;gap:20px;height:72px}
    .brand{display:flex;align-items:center;gap:10px}.brand-logo{width:36px;height:36px;border-radius:8px;box-shadow:0 4px 18px rgba(0,0,0,.3)}
    .brand-text{font-weight:800;letter-spacing:.6px}
    .main-nav{display:flex;gap:28px;justify-content:center;flex:1}
    .header-cta{display:flex;align-items:center;gap:12px}
    .lang-label{font-size:12px;opacity:.7}
    .lang-select{appearance:none;background:#101826;border:1px solid var(--line);color:var(--text);border-radius:12px;padding:8px 32px 8px 10px}
    .btn{border:0;padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn-ghost{background:transparent;color:#cfcfcf}.btn-ghost:hover{background:rgba(255,255,255,.06)}
    .btn-gold{background:linear-gradient(180deg,var(--gold1),var(--gold2));color:#170f04;font-weight:700;border-radius:14px;padding:12px 18px;box-shadow:0 8px 26px rgba(201,163,91,.35)}
    .btn-chip{background:var(--chip);color:#dfe3ea;border:1px solid var(--line);border-radius:14px;padding:10px 14px}
    .hero{padding:48px 0 24px;background:radial-gradient(1200px 500px at 20% -10%,rgba(244,215,140,.12),transparent),radial-gradient(1200px 600px at 100% 0,rgba(78,94,130,.18),transparent)}
    .hero-title{font-size:48px;letter-spacing:.2px;margin:10px 0 8px}.accent{color:#f1cf84}
    .hero-sub{opacity:.85;margin:8px 0 28px}
    .search-bar{display:grid;grid-template-columns:1.2fr .7fr .7fr auto auto;gap:10px;align-items:center}
    .input{background:#0f1621;border:1px solid var(--line);color:var(--text);padding:12px 14px;border-radius:12px}
    .input::placeholder{color:#a7b0bf}
    .search-status{margin-top:8px;color:#cfd6e6;opacity:0;transition:opacity .3s}
    .btn.loading{opacity:.65;pointer-events:none}
    .features{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-top:28px}
    .card{background:#0f1420;border:1px solid var(--line);border-radius:16px;padding:18px;box-shadow:0 8px 30px rgba(0,0,0,.25)}
    .card h3{margin:0 0 6px}.card p{margin:0;opacity:.85}
    .map-section{padding:36px 0 60px}
    #map{height:420px;border-radius:16px;border:1px solid var(--line);box-shadow:0 8px 30px rgba(0,0,0,.25);overflow:hidden}
    .leaflet-container,.leaflet-pane,.leaflet-top,.leaflet-bottom{z-index:10 !important}
    #filterDrawer{position:fixed;inset:0;display:none;z-index:2147483637;align-items:stretch;justify-content:flex-end}
    #filterDrawer[aria-hidden="false"]{display:flex}
    #filterDrawer .back{position:absolute;inset:0;background:rgba(0,0,0,.45)}
    #filterDrawer .panel{position:relative;margin-left:auto;width:min(780px,92vw);max-height:92vh;overflow:auto;background:var(--panel);border-left:1px solid var(--line);border-top-left-radius:16px;border-bottom-left-radius:16px;display:flex;flex-direction:column}
    #filterDrawer .head,#filterDrawer .foot{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--line)}
    #filterDrawer .foot{border-bottom:0;border-top:1px solid var(--line)}
    #filterGrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px;padding:14px}
    #filterDrawer .box{background:#0f1420;border:1px solid var(--line);border-radius:12px;padding:12px}
    #filterDrawer h4{margin:0 0 8px;font-size:14px}
    .sw-badge{position:absolute;top:-8px;right:-8px;background:#ffd36e;color:#1a1205;border-radius:999px;font-size:11px;padding:2px 6px}
    #chatFab{position:fixed;right:20px;bottom:20px;width:56px;height:56px;border-radius:50%;border:0;cursor:pointer;z-index:2147483639;background:linear-gradient(180deg,var(--gold1),var(--gold2));box-shadow:0 14px 30px rgba(201,163,91,.35);font-size:22px}
    #botPanel{position:fixed;right:20px;bottom:86px;width:min(360px,88vw);height:480px;background:#101018;border:1px solid #23232b;border-radius:16px;z-index:2147483638;display:none;box-shadow:0 20px 60px rgba(0,0,0,.5);color:var(--text)}
    #botPanel .hdr{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--line)}
    #botPanel .body{height:360px;overflow:auto;padding:10px;display:flex;flex-direction:column;gap:8px}
    #botPanel .row{display:flex;gap:8px;padding:10px;border-top:1px solid var(--line)}
    #botInput{flex:1;background:#0f1621;border:1px solid var(--line);color:var(--text);border-radius:12px;padding:10px 12px}
    #botSend{border:0;border-radius:12px;padding:10px 14px;background:linear-gradient(180deg,var(--gold1),var(--gold2));color:#1a1205;font-weight:700}
    .msg{max-width:80%;padding:10px 12px;border-radius:12px}.me{align-self:flex-end;background:#132132}.ai{align-self:flex-start;background:#121820}
    .site-footer{padding:28px 0;border-top:1px solid var(--line);opacity:.8}
    @media (max-width:920px){.main-nav{display:none}.hero-title{font-size:40px}.search-bar{grid-template-columns:1fr 1fr 1fr auto}}
    @media (max-width:640px){.hero-title{font-size:34px}.features{grid-template-columns:1fr}}
  </style>
</head>

<body>
  <!-- HEADER -->
  <header class="site-header">
    <div class="container header-row">
      <a href="/" class="brand">
        <img src="stayworld-logo.png" alt="StayWorld" class="brand-logo" />
        <span class="brand-text">STAYWORLD</span>
      </a>

      <nav class="main-nav" aria-label="Primary">
        <a href="index.html">Home</a>
        <a href="membership.html">Membership</a>
        <a href="login.html">Login</a>
      </nav>

      <div class="header-cta">
        <label for="lang" class="lang-label">Language</label>
        <select id="lang" class="lang-select">
          <option value="EN" selected>EN</option><option>KO</option><option>JA</option><option>ZH</option><option>FR</option>
          <option>ES</option><option>DE</option><option>TR</option><option>AR</option><option>RU</option>
        </select>
        <!-- ÌÜµÌôî ÏÑ†ÌÉù(Ìó§Îçî) -->
        <select id="currency" class="lang-select" style="margin-left:8px">
          <option>USD</option><option>EUR</option><option>KRW</option><option>JPY</option><option>CNY</option>
          <option>TRY</option><option>GBP</option><option>AED</option><option>RUB</option><option>ARS</option>
        </select>

        <a href="signup.html" class="btn btn-gold">Sign Up</a>
      </div>
    </div>
  </header>

  <!-- HERO -->
  <section class="hero">
    <div class="container">
      <h1 class="hero-title"><span>Luxury stays.</span><br><span class="accent">Global reach.</span></h1>
      <p class="hero-sub">Cards, bank transfer & crypto (BTC ¬∑ ETH ¬∑ USDT).</p>

      <div class="search-bar">
        <input class="input" id="searchDestination" type="text" placeholder="Paris, Tokyo, Istanbul‚Ä¶">
        <input class="input" id="checkIn" type="date">
        <input class="input" id="checkOut" type="date">
        <button class="btn btn-chip" id="btnFilters" type="button">Filters</button>
        <button class="btn btn-gold" id="btnSearch" type="button">Search</button>
      </div>
      <div id="searchStatus" class="search-status"></div>

      <div class="features">
        <div class="card"><h3>Verified stays</h3><p>Top picks near you.</p></div>
        <div class="card"><h3>StayWorld+ Rewards</h3><p>Earn points on every booking.</p></div>
        <div class="card"><h3>Secure payments</h3><p>Visa, Mastercard, Amex & Crypto.</p></div>
      </div>
    </div>
  </section>

  <!-- MAP -->
  <section class="map-section">
    <div class="container"><div id="map" aria-label="Map" role="region"></div></div>
  </section>

  <!-- APP JS -->
  <script>
  // ---------- i18n (Í∞ÑÎã® Î≤ÑÏ†Ñ: Î≤ÑÌäº/ÎùºÎ≤®Îßå) ----------
  const I18N = {
    EN:{filters:"Filters",search:"Search",f_title:"Filters",f_reset:"Reset",f_apply:"Apply",f_currency:"Currency",f_price:"Price per night"},
    KO:{filters:"ÌïÑÌÑ∞",search:"Í≤ÄÏÉâ",f_title:"ÌïÑÌÑ∞",f_reset:"Ï¥àÍ∏∞Ìôî",f_apply:"Ï†ÅÏö©",f_currency:"ÌÜµÌôî",f_price:"1Î∞ï Í∞ÄÍ≤©"},
    JA:{filters:"„Éï„Ç£„É´„Çø„Éº",search:"Ê§úÁ¥¢",f_title:"„Éï„Ç£„É´„Çø„Éº",f_reset:"„É™„Çª„ÉÉ„Éà",f_apply:"ÈÅ©Áî®",f_currency:"ÈÄöË≤®",f_price:"1Ê≥ä„ÅÆ‰æ°Ê†º"},
    ZH:{filters:"Á≠õÈÄâ",search:"ÊêúÁ¥¢",f_title:"Á≠õÈÄâ",f_reset:"ÈáçÁΩÆ",f_apply:"Â∫îÁî®",f_currency:"Ë¥ßÂ∏Å",f_price:"ÊØèÊôö‰ª∑Ê†º"},
    FR:{filters:"Filtres",search:"Rechercher",f_title:"Filtres",f_reset:"R√©initialiser",f_apply:"Appliquer",f_currency:"Devise",f_price:"Prix par nuit"},
    ES:{filters:"Filtros",search:"Buscar",f_title:"Filtros",f_reset:"Limpiar",f_apply:"Aplicar",f_currency:"Moneda",f_price:"Precio por noche"},
    DE:{filters:"Filter",search:"Suchen",f_title:"Filter",f_reset:"Zur√ºcksetzen",f_apply:"Anwenden",f_currency:"W√§hrung",f_price:"Preis pro Nacht"},
    TR:{filters:"Filtreler",search:"Ara",f_title:"Filtreler",f_reset:"Sƒ±fƒ±rla",f_apply:"Uygula",f_currency:"Para birimi",f_price:"Gecelik fiyat"},
    AR:{filters:"ÿßŸÑŸÅŸÑÿßÿ™ÿ±",search:"ÿ®ÿ≠ÿ´",f_title:"ÿßŸÑŸÅŸÑÿßÿ™ÿ±",f_reset:"ÿ•ÿπÿßÿØÿ© ÿ∂ÿ®ÿ∑",f_apply:"ÿ™ÿ∑ÿ®ŸäŸÇ",f_currency:"ÿßŸÑÿπŸÖŸÑÿ©",f_price:"ÿßŸÑÿ≥ÿπÿ± ŸÑŸÑŸäŸÑÿ©"},
    RU:{filters:"–§–∏–ª—å—Ç—Ä—ã",search:"–ü–æ–∏—Å–∫",f_title:"–§–∏–ª—å—Ç—Ä—ã",f_reset:"–°–±—Ä–æ—Å–∏—Ç—å",f_apply:"–ü—Ä–∏–º–µ–Ω–∏—Ç—å",f_currency:"–í–∞–ª—é—Ç–∞",f_price:"–¶–µ–Ω–∞ –∑–∞ –Ω–æ—á—å"},
  };
  const getLang=()=>document.getElementById('lang').value||'EN';
  const t=(k)=> (I18N[getLang()]?.[k]) || (I18N.EN[k]||k);

  document.getElementById('lang').addEventListener('change',()=>{
    document.getElementById('btnFilters').textContent=t('filters');
    document.getElementById('btnSearch').textContent=t('search');
    if (document.getElementById('filterDrawer')?.getAttribute('aria-hidden')==='false') localizeDrawer();
  });

  // ---------- ÌÜµÌôî & ÌôòÏú® ----------
  const FX = { USD:1, EUR:0.92, KRW:1380, JPY:156, CNY:7.25, TRY:33, GBP:0.78, AED:3.67, RUB:90, ARS:920 };
  (async()=>{ // Í∞ÄÎä•ÌïòÎ©¥ ÏµúÏã† ÌôòÏú® Î≥¥Ï†ï (Ïã§Ìå®Ìï¥ÎèÑ Î¨¥Ïãú)
    try{
      const r=await fetch("https://open.er-api.com/v6/latest/USD"); const j=await r.json();
      if(j?.rates) Object.keys(FX).forEach(k=>{ if(j.rates[k]) FX[k]=j.rates[k];});
    }catch(_){}
  })();
  const curSelHeader = document.getElementById('currency');
  function fmtMoneyByHeader(usd){
    const cur = curSelHeader.value || 'USD';
    const val = (usd||0) * (FX[cur]||1);
    try { return new Intl.NumberFormat(undefined,{style:"currency",currency:cur,maximumFractionDigits:0}).format(val); }
    catch(_) { return `${cur} ${Math.round(val).toLocaleString()}`; }
  }
  // Ïñ∏Ïñ¥ Î∞îÍæ∏Î©¥ ÌÜµÌôîÎèÑ ÎåÄÎûµ ÎßûÏ∂∞Ï£ºÍ∏∞
  const LANG_TO_CUR = { EN:'USD', KO:'KRW', JA:'JPY', ZH:'CNY', FR:'EUR', ES:'EUR', DE:'EUR', TR:'TRY', AR:'AED', RU:'RUB' };
  document.getElementById('lang').addEventListener('change', e=>{
    curSelHeader.value = LANG_TO_CUR[e.target.value] || 'USD';
    if (document.getElementById('filterDrawer')) updatePriceLabels();
  });

  // ---------- Ïò§Î≤ÑÎ†àÏù¥ Í∞ÄÎìú(Í≤ΩÎüâ) ----------
  function guardOn(panel){ panel.__prevPe = panel.style.pointerEvents; panel.style.pointerEvents='auto'; }
  function guardOff(panel){ if(panel && '__prevPe' in panel){ panel.style.pointerEvents=panel.__prevPe; } }

  // ---------- ÌïÑÌÑ∞ ÎìúÎ°úÏñ¥ ----------
  function ensureDrawer(){
    let d=document.getElementById('filterDrawer');
    if(d) return d;
    d=document.createElement('div'); d.id='filterDrawer'; d.setAttribute('aria-hidden','true');
    d.innerHTML=`
      <div class="back"></div>
      <div class="panel">
        <div class="head">
          <strong id="fTitle"></strong>
          <div style="display:flex;gap:8px;align-items:center">
            <label id="curLabel" style="font-size:12px;opacity:.8"></label>
            <select id="currencySelect" class="lang-select" style="padding:6px 10px">
              ${Object.keys(FX).map(k=>`<option>${k}</option>`).join('')}
            </select>
            <button id="swClose" class="btn btn-ghost">‚úï</button>
          </div>
        </div>
        <div id="filterGrid"></div>
        <div class="foot">
          <button id="swReset" class="btn btn-ghost" style="border:1px solid rgba(255,255,255,.14)"></button>
          <button id="swApply" class="btn btn-gold"></button>
        </div>
      </div>`;
    document.body.appendChild(d);

    const grid=d.querySelector('#filterGrid');
    const GROUPS=[
      {t:'f_price', kind:'price'},
      {t:'Stay type', checks:['Hotel','Motel','Hostel','Apartment','Villa','Ryokan','Guesthouse','B&B']},
      {t:'Review score', radios:['4.5+','4.0+','Any']},
      {t:'Beds & Baths', inputs:[['number','beds',{min:1,value:1}],['number','baths',{min:1,value:1}]]},
      {t:'Amenities', checks:['Wi-Fi','Kitchen','Parking','Pool','Air conditioning','Gym','Workspace','Washer','Dryer','Breakfast']}
    ];
    GROUPS.forEach((g,gi)=>{
      const box=document.createElement('div'); box.className='box';
      const title = g.t === 'f_price' ? t('f_price') : g.t;
      box.innerHTML=`<h4>${title}</h4>`;
      if(g.kind==='price'){
        box.insertAdjacentHTML('beforeend',`
          <div style="display:grid;gap:10px">
            <div style="display:flex;justify-content:space-between;font-size:13px">
              <span>${t('f_price')}</span>
              <span><span id="priceMinVal">‚Äì</span> ~ <span id="priceMaxVal">‚Äì</span></span>
            </div>
            <label style="font-size:12px;opacity:.8">Min</label>
            <input type="range" id="priceMin" min="0" max="1000" step="10" value="100">
            <label style="font-size:12px;opacity:.8">Max</label>
            <input type="range" id="priceMax" min="0" max="5000" step="50" value="800">
          </div>`);
      }
      (g.inputs||[]).forEach(([type,id,attrs])=>{
        const wrap=document.createElement('div'); wrap.style.margin='6px 0';
        wrap.innerHTML=`<label style="font-size:12px">${id}</label><input type="${type}" id="${id}" style="width:100%">`;
        Object.entries(attrs||{}).forEach(([k,v])=>wrap.querySelector('input').setAttribute(k,v));
        box.appendChild(wrap);
      });
      (g.radios||[]).forEach((name,ri)=>{
        const lab=document.createElement('label'); lab.style.cssText='display:inline-flex;align-items:center;gap:6px;margin:6px 10px 0 0';
        lab.innerHTML=`<input type="radio" name="rg_${gi}" ${/Any/i.test(name)?'checked':''}> <span>${name}</span>`;
        box.appendChild(lab);
      });
      (g.checks||[]).forEach((name)=>{
        const lab=document.createElement('label'); lab.style.cssText='display:inline-flex;align-items:center;gap:6px;margin:6px 10px 0 0';
        lab.innerHTML=`<input type="checkbox"> <span>${name}</span>`;
        box.appendChild(lab);
      });
      grid.appendChild(box);
    });

    // ÎèôÏûë
    const back=d.querySelector('.back');
    const close=()=>{d.setAttribute('aria-hidden','true'); guardOff(d.querySelector('.panel'));};
    back.addEventListener('click',close);
    d.querySelector('#swClose').addEventListener('click',close);
    d.querySelector('#currencySelect').addEventListener('change', updatePriceLabels);
    ['priceMin','priceMax'].forEach(id=>{
      d.addEventListener('input', (e)=>{ if(e.target.id===id) updatePriceLabels();});
    });
    d.querySelector('#swReset').addEventListener('click',()=>{
      d.querySelectorAll('input[type=checkbox]').forEach(i=>i.checked=false);
      d.querySelectorAll('input[type=radio]').forEach(i=>i.checked=i.nextSibling?.textContent?.includes('Any'));
      d.querySelector('#priceMin').value=100; d.querySelector('#priceMax').value=800; updatePriceLabels(); setBadge('');
    });
    d.querySelector('#swApply').addEventListener('click',()=>{
      const n=d.querySelectorAll('input[type=checkbox]:checked, input[type=radio]:checked').length;
      setBadge(n?n.toString():''); close();
    });

    return d;
  }

  function localizeDrawer(){
    const d=document.getElementById('filterDrawer'); if(!d) return;
    d.querySelector('#fTitle').textContent=t('f_title');
    d.querySelector('#curLabel').textContent=t('f_currency');
    d.querySelector('#swReset').textContent=t('f_reset');
    d.querySelector('#swApply').textContent=t('f_apply');
    // Í∞ÄÍ≤© ÌÉÄÏù¥ÌãÄ Í∞±Ïã†
    const priceHead = Array.from(d.querySelectorAll('#filterGrid .box h4')).find(h=>/price/i.test(h.textContent));
    if (priceHead) priceHead.textContent = t('f_price');
    // Í∞ÄÍ≤© ÎùºÎ≤® Í∞±Ïã†
    updatePriceLabels();
  }

  function updatePriceLabels(){
    const d=document.getElementById('filterDrawer'); if(!d) return;
    const cur = document.getElementById('currencySelect').value || curSelHeader.value || 'USD';
    const min=+d.querySelector('#priceMin').value||0;
    const max=+d.querySelector('#priceMax').value||0;
    const f = (usd)=>{
      const val = usd*(FX[cur]||1);
      try { return new Intl.NumberFormat(undefined,{style:'currency',currency:cur,maximumFractionDigits:0}).format(val); }
      catch(_){ return `${cur} ${Math.round(val).toLocaleString()}`; }
    };
    const minEl=d.querySelector('#priceMinVal'); const maxEl=d.querySelector('#priceMaxVal');
    if(minEl) minEl.textContent=f(min);
    if(maxEl) maxEl.textContent=f(max);
  }

  function setBadge(text){
    const btn=document.getElementById('btnFilters'); btn.style.position='relative';
    let b=btn.querySelector('.sw-badge'); 
    if(text){ if(!b){b=document.createElement('span');b.className='sw-badge';btn.appendChild(b);} b.textContent=text; }
    else if(b){ b.remove(); }
  }

  function openDrawer(){
    const d=ensureDrawer();
    // Ìó§Îçî ÌÜµÌôî ÏÑ†ÌÉùÍ∞íÏùÑ ÎìúÎ°úÏñ¥ ÌÜµÌôîÎ°ú ÎèôÍ∏∞Ìôî
    d.querySelector('#currencySelect').value = curSelHeader.value;
    d.setAttribute('aria-hidden','false');
    localizeDrawer();
    guardOn(d.querySelector('.panel'));
  }

  document.getElementById('btnFilters').addEventListener('click', (e)=>{ e.stopPropagation(); openDrawer(); });

  // ---------- Ï±óÎ¥á ----------
  (function ensureChat(){
    let fab=document.getElementById('chatFab');
    if(!fab){ fab=document.createElement('button'); fab.id='chatFab'; fab.textContent='üí¨'; document.body.appendChild(fab); }
    let panel=document.getElementById('botPanel');
    if(!panel){
      panel=document.createElement('div'); panel.id='botPanel';
      panel.innerHTML=`<div class="hdr"><strong>AI Concierge</strong><button id="botClose" class="btn btn-ghost">‚úï</button></div>
        <div id="botBody" class="body"><div class="msg ai">Hello! Ask in any language.</div></div>
        <div class="row"><input id="botInput" placeholder="Type a message‚Ä¶"><button id="botSend">Send</button></div>`;
      document.body.appendChild(panel);
    }
    const open=()=>{panel.style.display='block';};
    const close=()=>{panel.style.display='none';};
    fab.addEventListener('click',open);
    panel.querySelector('#botClose').addEventListener('click',close);
    const body=panel.querySelector('#botBody'), input=panel.querySelector('#botInput'), send=panel.querySelector('#botSend');
    const msgs=[]; const add=(t,me)=>{const d=document.createElement('div'); d.className=`msg ${me?'me':'ai'}`; d.textContent=t; body.appendChild(d); body.scrollTop=body.scrollHeight;};
    async function askAI(message,lang){
      try{
        const r=await fetch('/.netlify/functions/sw-chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({messages:[...msgs,{role:'user',content:message}],lang})});
        if(r.ok){const d=await r.json(); if(d.reply) return d.reply;}
      }catch(_){}
      return '(Backend not found. Check Netlify function.)';
    }
    async function sendIt(){
      const v=(input.value||'').trim(); if(!v) return; input.value='';
      add(v,true); msgs.push({role:'user',content:v}); add('‚Ä¶',false); const dots=body.lastChild;
      try{ const reply=await askAI(v,(document.getElementById('lang').value||'EN').toLowerCase()); dots.remove(); add(reply,false); msgs.push({role:'assistant',content:reply}); }
      catch(_){ dots.remove(); add('Assistant is unavailable.',false); }
    }
    send.addEventListener('click',sendIt); input.addEventListener('keydown',e=>{if(e.key==='Enter') sendIt();});
  })();

  // ---------- ÏßÄÎèÑ + Í≤ÄÏÉâ ----------
  let map=L.map('map',{scrollWheelZoom:true}).setView([48.8566,2.3522],12); // Paris
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap'}).addTo(map);
  let marker;
  function goTo(lat,lon,label){ if(marker) marker.remove(); marker=L.marker([lat,lon]).addTo(map).bindPopup(label||'').openPopup(); map.setView([lat,lon],13,{animate:true}); document.getElementById('map').scrollIntoView({behavior:'smooth',block:'start'}); }
  const statusEl=document.getElementById('searchStatus');
  function setStatus(msg){ statusEl.textContent=msg||''; statusEl.style.opacity=msg?1:0; if(msg){clearTimeout(statusEl._t); statusEl._t=setTimeout(()=>statusEl.style.opacity=0,3000);} }
  function setLoading(on){ const b=document.getElementById('btnSearch'); b.disabled=on; b.classList.toggle('loading',on); b.textContent=on?'‚Ä¶':t('search');}
  async function geocodeAny(q){
    const prov=[q=>`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(q)}`,q=>`https://photon.komoot.io/api/?limit=1&q=${encodeURIComponent(q)}`];
    for(const make of prov){
      try{
        const r=await fetch(make(q),{headers:{'Accept':'application/json'}}); if(!r.ok) continue; const data=await r.json();
        if(Array.isArray(data)&&data[0]) return {lat:+data[0].lat,lon:+data[0].lon,label:data[0].display_name||q};
        if(data?.features?.[0]){const f=data.features[0];return {lat:f.geometry.coordinates[1],lon:f.geometry.coordinates[0],label:f.properties.name||f.properties.city||f.properties.country||q};}
      }catch(_){}
    }
    throw new Error('no_results');
  }
  async function runSearch(){
    const q=(document.getElementById('searchDestination').value||'').trim(); if(!q){document.getElementById('searchDestination').focus(); return;}
    try{ setLoading(true); setStatus('Searching‚Ä¶'); const {lat,lon,label}=await geocodeAny(q); goTo(lat,lon,label); setStatus(`Found: ${label}`);}
    catch(_){ setStatus('No results. Try another place.'); alert('Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§. Îã§Î•∏ ÎèÑÏãúÎ•º ÏûÖÎ†•Ìï¥Î≥¥ÏÑ∏Ïöî.'); }
    finally{ setLoading(false); }
  }
  document.getElementById('btnSearch').addEventListener('click',runSearch);
  ['searchDestination','checkIn','checkOut'].forEach(id=>{const el=document.getElementById(id); el&&el.addEventListener('keydown',e=>{if(e.key==='Enter') runSearch();});});
  </script>

  <!-- FOOTER -->
  <footer class="site-footer">
    <div class="container"><small>¬© StayWorld ‚Äî stayworldbooking.com</small></div>
  </footer>
</body>
</html>
