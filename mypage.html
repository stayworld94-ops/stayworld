<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>StayWorld — My Page</title>
  <link rel="icon" href="/stayworld-logo.png" />
  <style>
    :root{--bg:#0b0b0c;--card:#131417;--muted:#9aa0a6;--text:#e8eaed;--accent:#ffd166;--ok:#4caf50;--warn:#ff9800;--danger:#ef5350;--border:#23252a}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0a0a0b,#0d0f12);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    a{color:var(--accent);text-decoration:none}
    .container{max-width:1100px;margin:0 auto;padding:24px}
    .site-header{position:sticky;top:0;z-index:30;background:rgba(10,10,12,0.8);backdrop-filter:saturate(140%) blur(10px);border-bottom:1px solid var(--border)}
    .header-row{display:flex;align-items:center;justify-content:space-between}
    .brand{display:flex;gap:10px;align-items:center}
    .brand-logo{height:34px;width:34px;border-radius:10px;box-shadow:0 0 0 2px #222}
    .brand-text{font-weight:800;letter-spacing:1.5px}
    nav.main-nav{display:flex;gap:16px;align-items:center}
    nav.main-nav a{padding:8px 10px;border-radius:10px}
    nav.main-nav a:hover{background:#181a1f}

    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#0f1115}
    .select{appearance:none;background:#0f1115;border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:12px}

    .grid{display:grid;gap:16px}
    @media(min-width:920px){.grid-2{grid-template-columns:1.1fr .9fr}}

    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.35);overflow:hidden}
    .card-h{display:flex;align-items:center;justify-content:space-between;padding:18px 20px;border-bottom:1px solid var(--border)}
    .card-c{padding:18px 20px}
    .muted{color:var(--muted)}
    .chip{display:inline-block;font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#111319}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .btn{cursor:pointer;padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:#16181f;color:var(--text);user-select:none}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn:hover{background:#1a1d25}
    .btn.primary{background:linear-gradient(180deg,#1d2028,#181b22);border-color:#2a2f3a}
    .btn.danger{border-color:#40222a;background:#2a1418}
    .btn.ok{border-color:#1f3b23;background:#122015}

    #map{height:380px;border-radius:16px;border:1px solid var(--border)}

    .booking{display:grid;grid-template-columns:64px 1fr auto;gap:14px;align-items:center;padding:14px 0;border-bottom:1px dashed #23262d}
    .booking:last-child{border-bottom:none}
    .thumb{height:64px;width:64px;border-radius:12px;background:#0f1115;border:1px solid var(--border);object-fit:cover}

    .empty{display:flex;align-items:center;justify-content:center;gap:10px;padding:22px;border:1px dashed #2a2e35;border-radius:14px;color:var(--muted)}

    .footer{padding:30px 0;color:#8b9098;text-align:center}
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container header-row">
      <a href="/" class="brand">
        <img src="/stayworld-logo.png" class="brand-logo" alt="StayWorld"/>
        <span class="brand-text">STAYWORLD</span>
      </a>
      <nav class="main-nav">
        <a href="index.html" data-i18n="nav_home">Home</a>
        <a href="membership.html" data-i18n="nav_membership">Membership</a>
        <a href="/login.html" id="loginLink" data-i18n="nav_login">Login</a>
        <button id="logoutBtn" class="btn" style="display:none" data-i18n="logout">Logout</button>

        <!-- ✅ Host / Become a host (역할에 따라 토글됨) -->
        <a id="hostLink" class="btn" href="/host.html" style="display:none" data-i18n="host">Host</a>
        <a id="becomeHostLink" class="btn" href="/host-onboarding.html" style="display:none" data-i18n="become_host">Become a host</a>

        <select id="langSelect" class="select" aria-label="Language">
          <option value="en">English</option>
          <option value="ko">한국어</option>
          <option value="fr">Français</option>
          <option value="tr">Türkçe</option>
          <option value="ja">日本語</option>
          <option value="de">Deutsch</option>
          <option value="es">Español</option>
          <option value="ru">Русский</option>
          <option value="it">Italiano</option>
          <option value="zh">简体中文</option>
        </select>
      </nav>
    </div>
  </header>

  <main class="container grid grid-2">
    <!-- Profile / Summary -->
    <section class="card">
      <div class="card-h">
        <h2 data-i18n="my_page">My Page</h2>
        <span class="chip" id="userLevel">Bronze</span>
      </div>
      <div class="card-c">
        <div class="row" style="justify-content:space-between">
          <div>
            <div class="muted" data-i18n="signed_in_as">Signed in as</div>
            <div id="userName" style="font-weight:700;font-size:18px">—</div>
            <div id="userEmail" class="muted">—</div>
          </div>
          <div>
            <div class="muted" data-i18n="points">Points</div>
            <div id="userPoints" style="font-size:20px;font-weight:700">0</div>
          </div>
        </div>
        <div class="row" style="margin-top:14px">
          <a class="btn primary" href="/results.html" data-i18n="find_stays">Find stays</a>
          <a class="btn" href="/settings.html" data-i18n="settings">Settings</a>
        </div>
      </div>
    </section>

    <!-- My Locations (Map) -->
    <section class="card">
      <div class="card-h">
        <h2 data-i18n="my_locations">My Locations</h2>
        <span class="muted" id="locationsCount">0</span>
      </div>
      <div class="card-c">
        <div class="row" style="margin-bottom:10px">
          <input id="addrInput" class="select" style="flex:1;min-width:220px" placeholder="주소를 입력하세요 / Enter address"/>
          <button id="geoBtn" class="btn ok" data-i18n="geo_btn">주소 좌표 변환</button>
        </div>
        <div id="geoResult" class="muted" style="margin-bottom:10px"></div>
        <div id="map"></div>
      </div>
    </section>

    <!-- My Bookings -->
    <section class="card" style="grid-column:1 / -1">
      <div class="card-h">
        <h2 data-i18n="my_bookings">My Bookings</h2>
        <span class="muted" id="bookingsCount">0</span>
      </div>
      <div class="card-c" id="bookingsList">
        <div class="empty"><span>🗂️</span> <span data-i18n="no_bookings">No bookings yet.</span></div>
      </div>
    </section>
  </main>

  <footer class="footer container">
    <div>© <span id="year"></span> STAYWORLD • <span class="muted" data-i18n="all_rights">All rights reserved.</span></div>
  </footer>

  <!-- i18n (10 languages) -->
  <script>
    const I18N = {
      en:{nav_home:"Home",nav_membership:"Membership",nav_login:"Login",logout:"Logout",my_page:"My Page",signed_in_as:"Signed in as",points:"Points",find_stays:"Find stays",settings:"Settings",my_locations:"My Locations",my_bookings:"My Bookings",no_bookings:"No bookings yet.",check_in:"Check-in",check_out:"Check-out",status:"Status",price:"Price",payment_status:"Payment",cancel:"Cancel",cancel_requested:"Cancel requested",sign_in_prompt:"Please sign in to view your page.",all_rights:"All rights reserved.",addr_placeholder:"Enter address",geo_btn:"Geocode address",geo_result_prefix:"Result",host:"Host",become_host:"Become a host"},
      ko:{nav_home:"홈",nav_membership:"멤버십",nav_login:"로그인",logout:"로그아웃",my_page:"마이페이지",signed_in_as:"로그인 계정",points:"포인트",find_stays:"숙소 찾기",settings:"설정",my_locations:"내 위치 리스트",my_bookings:"내 예약",no_bookings:"아직 예약이 없습니다.",check_in:"체크인",check_out:"체크아웃",status:"상태",price:"결제금액",payment_status:"결제",cancel:"예약 취소",cancel_requested:"취소 요청됨",sign_in_prompt:"마이페이지 보기를 위해 로그인해주세요.",all_rights:"모든 권리 보유.",addr_placeholder:"주소 입력",geo_btn:"주소 좌표 변환",geo_result_prefix:"결과",host:"호스트",become_host:"호스트 신청"},
      fr:{nav_home:"Accueil",nav_membership:"Abonnement",nav_login:"Connexion",logout:"Déconnexion",my_page:"Mon espace",signed_in_as:"Connecté en tant que",points:"Points",find_stays:"Trouver des séjours",settings:"Paramètres",my_locations:"Mes lieux",my_bookings:"Mes réservations",no_bookings:"Aucune réservation.",check_in:"Arrivée",check_out:"Départ",status:"Statut",price:"Montant",payment_status:"Paiement",cancel:"Annuler",cancel_requested:"Annulation demandée",sign_in_prompt:"Veuillez vous connecter pour voir votre espace.",all_rights:"Tous droits réservés.",addr_placeholder:"Saisir l'adresse",geo_btn:"Géocoder l'adresse",geo_result_prefix:"Résultat",host:"Hôte",become_host:"Devenir hôte"},
      tr:{nav_home:"Ana sayfa",nav_membership:"Üyelik",nav_login:"Giriş",logout:"Çıkış",my_page:"Hesabım",signed_in_as:"Olarak giriş yapıldı",points:"Puan",find_stays:"Konaklama bul",settings:"Ayarlar",my_locations:"Konumlarım",my_bookings:"Rezervasyonlarım",no_bookings:"Rezervasyon yok.",check_in:"Giriş",check_out:"Çıkış",status:"Durum",price:"Tutar",payment_status:"Ödeme",cancel:"İptal",cancel_requested:"İptal talep edildi",sign_in_prompt:"Sayfanızı görmek için giriş yapın.",all_rights:"Tüm hakları saklıdır.",addr_placeholder:"Adres girin",geo_btn:"Adresi jeokodla",geo_result_prefix:"Sonuç",host:"Ev sahibi",become_host:"Ev sahibi ol"},
      ja:{nav_home:"ホーム",nav_membership:"メンバーシップ",nav_login:"ログイン",logout:"ログアウト",my_page:"マイページ",signed_in_as:"ログイン中",points:"ポイント",find_stays:"宿泊先を探す",settings:"設定",my_locations:"マイロケーション",my_bookings:"予約一覧",no_bookings:"予約がありません。",check_in:"チェックイン",check_out:"チェックアウト",status:"ステータス",price:"金額",payment_status:"支払い",cancel:"キャンセル",cancel_requested:"キャンセル申請済み",sign_in_prompt:"表示するにはログインしてください。",all_rights:"無断転載禁止。",addr_placeholder:"住所を入力",geo_btn:"住所をジオコード",geo_result_prefix:"結果",host:"ホスト",become_host:"ホストになる"},
      de:{nav_home:"Startseite",nav_membership:"Mitgliedschaft",nav_login:"Anmelden",logout:"Abmelden",my_page:"Mein Bereich",signed_in_as:"Angemeldet als",points:"Punkte",find_stays:"Unterkünfte finden",settings:"Einstellungen",my_locations:"Meine Orte",my_bookings:"Meine Buchungen",no_bookings:"Keine Buchungen.",check_in:"Check-in",check_out:"Check-out",status:"Status",price:"Preis",payment_status:"Zahlung",cancel:"Stornieren",cancel_requested:"Stornierung angefordert",sign_in_prompt:"Zum Anzeigen bitte anmelden.",all_rights:"Alle Rechte vorbehalten.",addr_placeholder:"Adresse eingeben",geo_btn:"Adresse geokodieren",geo_result_prefix:"Ergebnis",host:"Host",become_host:"Host werden"},
      es:{nav_home:"Inicio",nav_membership:"Membresía",nav_login:"Iniciar sesión",logout:"Cerrar sesión",my_page:"Mi cuenta",signed_in_as:"Conectado como",points:"Puntos",find_stays:"Buscar alojamientos",settings:"Configuración",my_locations:"Mis ubicaciones",my_bookings:"Mis reservas",no_bookings:"Sin reservas.",check_in:"Check-in",check_out:"Check-out",status:"Estado",price:"Precio",payment_status:"Pago",cancel:"Cancelar",cancel_requested:"Cancelación solicitada",sign_in_prompt:"Inicia sesión para ver tu cuenta.",all_rights:"Todos los derechos reservados.",addr_placeholder:"Introducir dirección",geo_btn:"Geocodificar dirección",geo_result_prefix:"Resultado",host:"Anfitrión",become_host:"Hazte anfitrión"},
      ru:{nav_home:"Главная",nav_membership:"Подписка",nav_login:"Войти",logout:"Выйти",my_page:"Мой кабинет",signed_in_as:"Вошли как",points:"Баллы",find_stays:"Найти жильё",settings:"Настройки",my_locations:"Мои места",my_bookings:"Мои бронирования",no_bookings:"Бронирований нет.",check_in:"Заезд",check_out:"Выезд",status:"Статус",price:"Сумма",payment_status:"Оплата",cancel:"Отменить",cancel_requested:"Запрошена отмена",sign_in_prompt:"Войдите, чтобы просмотреть.",all_rights:"Все права защищены.",addr_placeholder:"Введите адрес",geo_btn:"Геокодировать адрес",geo_result_prefix:"Результат",host:"Хост",become_host:"Стать хостом"},
      it:{nav_home:"Home",nav_membership:"Abbonamento",nav_login:"Accedi",logout:"Esci",my_page:"Area personale",signed_in_as:"Collegato come",points:"Punti",find_stays:"Cerca alloggi",settings:"Impostazioni",my_locations:"Le mie posizioni",my_bookings:"Le mie prenotazioni",no_bookings:"Nessuna prenotazione.",check_in:"Check-in",check_out:"Check-out",status:"Stato",price:"Prezzo",payment_status:"Pagamento",cancel:"Annulla",cancel_requested:"Annullamento richiesto",sign_in_prompt:"Accedi per visualizzare.",all_rights:"Tutti i diritti riservati.",addr_placeholder:"Inserisci indirizzo",geo_btn:"Geocodifica indirizzo",geo_result_prefix:"Risultato",host:"Host",become_host:"Diventa host"},
      zh:{nav_home:"首页",nav_membership:"会员",nav_login:"登录",logout:"登出",my_page:"我的页面",signed_in_as:"登录帐号",points:"积分",find_stays:"查找住宿",settings:"设置",my_locations:"我的位置",my_bookings:"我的预订",no_bookings:"暂无预订。",check_in:"入住",check_out:"退房",status:"状态",price:"金额",payment_status:"支付",cancel:"取消",cancel_requested:"已申请取消",sign_in_prompt:"请登录以查看页面。",all_rights:"版权所有。",addr_placeholder:"输入地址",geo_btn:"地址地理编码",geo_result_prefix:"结果",host:"房东",become_host:"成为房东"}
    };
    function getLang(){ return localStorage.getItem('lang') || (navigator.language||'en').slice(0,2); }
    function setLang(lang){
      const pack = I18N[lang] || I18N.en;
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const k = el.getAttribute('data-i18n');
        if(pack[k]) el.textContent = pack[k];
      });
      const addr = document.getElementById('addrInput');
      if(addr){ addr.placeholder = pack.addr_placeholder || I18N.en.addr_placeholder; }
      document.documentElement.lang = lang;
      localStorage.setItem('lang', lang);
    }
  </script>

  <!-- App (Firebase + safe handlers) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ===== Utils: safe click & once =====
    function safeClick(btn, handler, {cooldownMs=600}={}){
      if(!btn) return;
      if(btn.dataset.bound) return; // prevent duplicate listeners
      btn.dataset.bound = "1";
      let inFlight = false;
      btn.addEventListener('click', async (ev)=>{
        if(inFlight || btn.disabled) return;
        inFlight = true;
        const prev = btn.textContent;
        btn.disabled = true;
        btn.setAttribute('aria-busy','true');
        try{
          await handler(ev, btn);
        }finally{
          setTimeout(()=>{ // brief cooldown to swallow double taps
            btn.disabled = false;
            btn.removeAttribute('aria-busy');
            btn.textContent = btn.dataset.restoreText || prev;
            inFlight = false;
          }, cooldownMs);
        }
      });
    }

    // ===== i18n init =====
    const langSelect = document.getElementById('langSelect');
    const initialLang = (()=>{ const l = getLang(); return I18N[l] ? l : 'en'; })();
    langSelect.value = initialLang; setLang(initialLang);
    langSelect.addEventListener('change', ()=> setLang(langSelect.value));

    // ===== Firebase =====
    const firebaseConfig = {
      apiKey: "AIzaSyCyb0pn2sFTEPkL0Q1ALwZaV2QILWyP_fk",
      authDomain: "stayworld-2570c.firebaseapp.com",
      projectId: "stayworld-2570c",
      storageBucket: "stayworld-2570c.firebasestorage.app",
      messagingSenderId: "272599681686",
      appId: "1:272599681686:web:33f89b66f7ee6f6f0b50b7",
      measurementId: "G-F8MXM3D7FJ"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // year
    document.getElementById('year').textContent = new Date().getFullYear();

    // header refs
    const loginLink   = document.getElementById('loginLink');
    const logoutBtn   = document.getElementById('logoutBtn');
    const hostLink    = document.getElementById('hostLink');
    const becomeHostLink = document.getElementById('becomeHostLink');

    const userLevel   = document.getElementById('userLevel');
    const userName    = document.getElementById('userName');
    const userEmail   = document.getElementById('userEmail');
    const userPoints  = document.getElementById('userPoints');

    // bookings / locations
    const bookingsList  = document.getElementById('bookingsList');
    const bookingsCount = document.getElementById('bookingsCount');
    const locationsCount= document.getElementById('locationsCount');

    // ===== Google Maps single-load (Promise singleton) =====
    let _gmapsPromise;
    function getGoogleMaps(){
      if(window.google?.maps) return Promise.resolve();
      if(_gmapsPromise) return _gmapsPromise;
      const apiKey = 'YOUR_GOOGLE_MAPS_KEY'; // TODO: AIzaSyDRUf7RDA9P7Iy8qyyDoAkvVtbouEEzwRY
      if(!apiKey || apiKey.includes('YOUR_')){
        console.warn('Google Maps API key missing');
        return Promise.resolve();
      }
      _gmapsPromise = new Promise((resolve, reject)=>{
        const cbName = '__mapsInit_'+Math.random().toString(36).slice(2);
        window[cbName] = ()=>{ resolve(); delete window[cbName]; };
        const s=document.createElement('script');
        s.src=`https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=${cbName}`;
        s.async=true; s.defer=true;
        s.onerror = (e)=>{ reject(e); };
        document.head.appendChild(s);
      });
      return _gmapsPromise;
    }

    // map helpers
    let map, markers=[];
    function ensureMap(center={lat:39.0,lng:35.0}){
      if(map || !window.google?.maps) return;
      map = new google.maps.Map(document.getElementById('map'), {center, zoom:5});
    }
    function clearMarkers(){ markers.forEach(m=>m.setMap(null)); markers=[]; }

    // ===== Level logic =====
    function computeLevel(points){
      if(points>=15000000) return 'Elite';
      if(points>=7500000)  return 'Diamond';
      if(points>=4000000)  return 'Platinum';
      if(points>=2000000)  return 'Gold';
      if(points>=500000)   return 'Silver';
      return 'Bronze';
    }

    // ===== Firestore: bookings =====
    async function fetchUserBookings(uid){
      const qRef = query(collection(db,'bookings'), where('user_id','==', uid));
      const snap = await getDocs(qRef);
      return snap.docs.map(d=>({ id:d.id, ...d.data() }));
    }

    function renderBookings(list, lang){
      const pack = I18N[lang]||I18N.en;
      bookingsList.innerHTML = '';
      if(!list.length){
        const div = document.createElement('div');
        div.className='empty';
        div.innerHTML = `🗂️ <span>${pack.no_bookings}</span>`;
        bookingsList.appendChild(div);
        bookingsCount.textContent='0';
        locationsCount.textContent='0';
        return;
      }
      bookingsCount.textContent = String(list.length);

      const locs = list
        .map(b=>({ lat:b?.location?.lat, lng:b?.location?.lng, name:b?.listing_title || 'Stay', id:b.id }))
        .filter(x=>typeof x.lat==='number' && typeof x.lng==='number');

      locationsCount.textContent = String(locs.length);

      if(locs.length){
        getGoogleMaps().then(()=>{
          if(window.google?.maps){
            ensureMap({lat:locs[0].lat, lng:locs[0].lng});
            clearMarkers();
            const bounds = new google.maps.LatLngBounds();
            locs.forEach(l=>{
              const m = new google.maps.Marker({position:{lat:l.lat,lng:l.lng}, map, title:l.name});
              markers.push(m);
              bounds.extend({lat:l.lat,lng:l.lng});
            });
            if(locs.length>1) map.fitBounds(bounds); else map.setZoom(12);
          }
        });
      }

      list.forEach(b=>{
        const item = document.createElement('div');
        item.className='booking';

        const thumb = document.createElement('img');
        thumb.className='thumb';
        thumb.alt=b.listing_title||'Stay';
        thumb.src=b.thumbUrl||'/placeholder-stay.jpg';

        const main = document.createElement('div');
        const title = document.createElement('div');
        title.style.fontWeight='700';
        title.textContent = b.listing_title || 'Stay';

        const meta = document.createElement('div');
        meta.className='muted';
        meta.innerHTML = `${pack.check_in}: <b>${b.check_in||'-'}</b> · ${pack.check_out}: <b>${b.check_out||'-'}</b>`;

        const meta2 = document.createElement('div');
        meta2.className='muted';
        const priceTxt = (typeof b.price_total!=='undefined')
          ? `${b.price_total}${b.currency||''}${b.refund_amount?` · refund: ${b.refund_amount}${b.currency||''}`:''}`
          : '-';
        meta2.innerHTML = `${pack.status}: <b>${b.status||'-'}</b> · ${pack.price}: <b>${priceTxt}</b>`;

        main.appendChild(title); main.appendChild(meta); main.appendChild(meta2);

        const actions = document.createElement('div');
        const cancelBtn = document.createElement('button');
        cancelBtn.className='btn danger';
        cancelBtn.textContent = pack.cancel;
        cancelBtn.disabled = b.status === 'canceled';

        // 중복 취소 가드
        safeClick(cancelBtn, async ()=>{
          if(cancelBtn.dataset.busy==="1") return;
          if(!confirm(pack.cancel+'?')) return;
          cancelBtn.dataset.busy="1";
          cancelBtn.dataset.restoreText = cancelBtn.textContent;
          cancelBtn.textContent = pack.cancel_requested;
          try{
            await updateDoc(doc(db,'bookings', b.id), { status:'canceled' });
            cancelBtn.disabled = true;
            item.style.opacity=.85;
          }catch(e){
            alert('Cancel failed: '+e.message);
            cancelBtn.textContent = cancelBtn.dataset.restoreText || pack.cancel;
            cancelBtn.dataset.busy="0";
          }
        }, {cooldownMs:800});

        actions.appendChild(cancelBtn);
        item.appendChild(thumb); item.appendChild(main); item.appendChild(actions);
        bookingsList.appendChild(item);
      });
    }

    // ===== Geocode (주소→좌표) =====
    async function geocodeAddress(address){
      if(!address) throw new Error('Empty address');
      await getGoogleMaps();
      if(!window.google?.maps) throw new Error('Maps not available');
      return new Promise((resolve, reject)=>{
        try{
          const geocoder = new google.maps.Geocoder();
          geocoder.geocode({ address }, (results, status)=>{
            if(status==='OK' && results?.[0]){
              const loc = results[0].geometry.location;
              resolve({ lat: loc.lat(), lng: loc.lng(), formatted: results[0].formatted_address });
            }else{
              reject(new Error('Geocode failed: '+status));
            }
          });
        }catch(e){ reject(e); }
      });
    }

    // ===== Buttons: safe attach =====
    const geoBtn   = document.getElementById('geoBtn');
    const addrInput= document.getElementById('addrInput');
    const geoOut   = document.getElementById('geoResult');

    safeClick(geoBtn, async (_ev, btn)=>{
      const lang = langSelect.value || getLang();
      const pack = I18N[lang] || I18N.en;
      const q = (addrInput?.value||'').trim();
      geoOut.textContent = '';
      btn.dataset.restoreText = btn.textContent;
      btn.textContent = '…';
      try{
        const r = await geocodeAddress(q);
        geoOut.textContent = `${pack.geo_result_prefix}: ${r.lat}, ${r.lng} (${r.formatted})`;
        // 지도에 표시
        if(window.google?.maps){
          ensureMap({lat:r.lat,lng:r.lng});
          clearMarkers();
          const m = new google.maps.Marker({position:{lat:r.lat,lng:r.lng}, map, title:r.formatted});
          markers.push(m);
          map.setCenter({lat:r.lat,lng:r.lng});
          map.setZoom(13);
        }
      }catch(e){
        geoOut.textContent = 'Geocode error: '+ e.message;
      }
    }, {cooldownMs:700});

    // ===== Auth state =====
    onAuthStateChanged(auth, async (user)=>{
      const lang = langSelect.value || getLang();

      // 기본 토글 초기화
      hostLink.style.display = 'none';
      becomeHostLink.style.display = 'none';

      if(!user){
        userName.textContent='—';
        userEmail.textContent= I18N[lang]?.sign_in_prompt || I18N.en.sign_in_prompt;
        loginLink.style.display='inline-flex';
        logoutBtn.style.display='none';
        renderBookings([], lang);
        return;
      }
      loginLink.style.display='none';
      logoutBtn.style.display='inline-flex';
      userName.textContent = user.displayName || 'Guest';
      userEmail.textContent = user.email || '';

      // ✅ 역할 확인 후 버튼 토글
      try {
        const snap = await getDoc(doc(db, 'users', user.uid));
        const role = snap.exists() ? (snap.data().role || 'guest') : 'guest';
        if (role === 'host') {
          hostLink.style.display = 'inline-flex';
          becomeHostLink.style.display = 'none';
        } else {
          hostLink.style.display = 'none';
          becomeHostLink.style.display = 'inline-flex';
        }
      } catch (e) {
        console.warn('role check failed', e);
        hostLink.style.display = 'none';
        becomeHostLink.style.display = 'none';
      }

      try{
        const list = await fetchUserBookings(user.uid);
        const points = list.reduce((s,b)=> s + (Number(b.pointsEarned)||0), 0);
        userPoints.textContent = String(points);
        userLevel.textContent  = computeLevel(points);
        renderBookings(list, lang);
      }catch(e){
        console.error(e);
        renderBookings([], lang);
      }
    });

    // logout: 중복 클릭 가드
    safeClick(logoutBtn, async ()=>{
      await signOut(auth);
    }, {cooldownMs:600});
  </script>
</body>
</html>
