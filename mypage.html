<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>StayWorld ‚Äî My Page</title>
  <link rel="icon" href="/stayworld-logo.png" />
  <style>
    :root{--bg:#0b0b0c;--card:#131417;--muted:#9aa0a6;--text:#e8eaed;--accent:#ffd166;--ok:#4caf50;--warn:#ff9800;--danger:#ef5350;--border:#23252a}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0a0a0b,#0d0f12);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    a{color:var(--accent);text-decoration:none}
    .container{max-width:1100px;margin:0 auto;padding:24px}
    .site-header{position:sticky;top:0;z-index:30;background:rgba(10,10,12,0.8);backdrop-filter:saturate(140%) blur(10px);border-bottom:1px solid var(--border)}
    .header-row{display:flex;align-items:center;justify-content:space-between}
    .brand{display:flex;gap:10px;align-items:center}
    .brand-logo{height:34px;width:34px;border-radius:10px;box-shadow:0 0 0 2px #222}
    .brand-text{font-weight:800;letter-spacing:1.5px}
    nav.main-nav{display:flex;gap:16px;align-items:center}
    nav.main-nav a{padding:8px 10px;border-radius:10px}
    nav.main-nav a:hover{background:#181a1f}

    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#0f1115}
    .select{appearance:none;background:#0f1115;border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:12px}

    .grid{display:grid;gap:16px}
    @media(min-width:920px){.grid-2{grid-template-columns:1.1fr .9fr}}

    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.35);overflow:hidden}
    .card-h{display:flex;align-items:center;justify-content:space-between;padding:18px 20px;border-bottom:1px solid var(--border)}
    .card-c{padding:18px 20px}
    .muted{color:var(--muted)}
    .chip{display:inline-block;font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#111319}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .btn{cursor:pointer;padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:#16181f;color:var(--text);user-select:none}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn:hover{background:#1a1d25}
    .btn.primary{background:linear-gradient(180deg,#1d2028,#181b22);border-color:#2a2f3a}
    .btn.danger{border-color:#40222a;background:#2a1418}
    .btn.ok{border-color:#1f3b23;background:#122015}

    #map{height:380px;border-radius:16px;border:1px solid var(--border)}

    .booking{display:grid;grid-template-columns:64px 1fr auto;gap:14px;align-items:center;padding:14px 0;border-bottom:1px dashed #23262d}
    .booking:last-child{border-bottom:none}
    .thumb{height:64px;width:64px;border-radius:12px;background:#0f1115;border:1px solid var(--border);object-fit:cover}

    .empty{display:flex;align-items:center;justify-content:center;gap:10px;padding:22px;border:1px dashed #2a2e35;border-radius:14px;color:var(--muted)}

    .footer{padding:30px 0;color:#8b9098;text-align:center}
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container header-row">
      <a href="/" class="brand">
        <img src="/stayworld-logo.png" class="brand-logo" alt="StayWorld"/>
        <span class="brand-text">STAYWORLD</span>
      </a>
      <nav class="main-nav">
        <a href="index.html" data-i18n="nav_home">Home</a>
        <a href="membership.html" data-i18n="nav_membership">Membership</a>
        <a href="/login.html" id="loginLink" data-i18n="nav_login">Login</a>
        <button id="logoutBtn" class="btn" style="display:none" data-i18n="logout">Logout</button>

        <!-- ‚úÖ Host / Become a host (Ïó≠Ìï†Ïóê Îî∞Îùº ÌÜ†Í∏ÄÎê®) -->
        <a id="hostLink" class="btn" href="/host.html" style="display:none" data-i18n="host">Host</a>
        <a id="becomeHostLink" class="btn" href="/host-onboarding.html" style="display:none" data-i18n="become_host">Become a host</a>

        <select id="langSelect" class="select" aria-label="Language">
          <option value="en">English</option>
          <option value="ko">ÌïúÍµ≠Ïñ¥</option>
          <option value="fr">Fran√ßais</option>
          <option value="tr">T√ºrk√ße</option>
          <option value="ja">Êó•Êú¨Ë™û</option>
          <option value="de">Deutsch</option>
          <option value="es">Espa√±ol</option>
          <option value="ru">–†—É—Å—Å–∫–∏–π</option>
          <option value="it">Italiano</option>
          <option value="zh">ÁÆÄ‰Ωì‰∏≠Êñá</option>
        </select>
      </nav>
    </div>
  </header>

  <main class="container grid grid-2">
    <!-- Profile / Summary -->
    <section class="card">
      <div class="card-h">
        <h2 data-i18n="my_page">My Page</h2>
        <span class="chip" id="userLevel">Bronze</span>
      </div>
      <div class="card-c">
        <div class="row" style="justify-content:space-between">
          <div>
            <div class="muted" data-i18n="signed_in_as">Signed in as</div>
            <div id="userName" style="font-weight:700;font-size:18px">‚Äî</div>
            <div id="userEmail" class="muted">‚Äî</div>
          </div>
          <div>
            <div class="muted" data-i18n="points">Points</div>
            <div id="userPoints" style="font-size:20px;font-weight:700">0</div>
          </div>
        </div>
        <div class="row" style="margin-top:14px">
          <a class="btn primary" href="/results.html" data-i18n="find_stays">Find stays</a>
          <a class="btn" href="/settings.html" data-i18n="settings">Settings</a>
        </div>
      </div>
    </section>

    <!-- My Locations (Map) -->
    <section class="card">
      <div class="card-h">
        <h2 data-i18n="my_locations">My Locations</h2>
        <span class="muted" id="locationsCount">0</span>
      </div>
      <div class="card-c">
        <div class="row" style="margin-bottom:10px">
          <input id="addrInput" class="select" style="flex:1;min-width:220px" placeholder="Ï£ºÏÜåÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî / Enter address"/>
          <button id="geoBtn" class="btn ok" data-i18n="geo_btn">Ï£ºÏÜå Ï¢åÌëú Î≥ÄÌôò</button>
        </div>
        <div id="geoResult" class="muted" style="margin-bottom:10px"></div>
        <div id="map"></div>
      </div>
    </section>

    <!-- My Bookings -->
    <section class="card" style="grid-column:1 / -1">
      <div class="card-h">
        <h2 data-i18n="my_bookings">My Bookings</h2>
        <span class="muted" id="bookingsCount">0</span>
      </div>
      <div class="card-c" id="bookingsList">
        <div class="empty"><span>üóÇÔ∏è</span> <span data-i18n="no_bookings">No bookings yet.</span></div>
      </div>
    </section>
  </main>

  <footer class="footer container">
    <div>¬© <span id="year"></span> STAYWORLD ‚Ä¢ <span class="muted" data-i18n="all_rights">All rights reserved.</span></div>
  </footer>

  <!-- i18n (10 languages) -->
  <script>
    const I18N = {
      en:{nav_home:"Home",nav_membership:"Membership",nav_login:"Login",logout:"Logout",my_page:"My Page",signed_in_as:"Signed in as",points:"Points",find_stays:"Find stays",settings:"Settings",my_locations:"My Locations",my_bookings:"My Bookings",no_bookings:"No bookings yet.",check_in:"Check-in",check_out:"Check-out",status:"Status",price:"Price",payment_status:"Payment",cancel:"Cancel",cancel_requested:"Cancel requested",sign_in_prompt:"Please sign in to view your page.",all_rights:"All rights reserved.",addr_placeholder:"Enter address",geo_btn:"Geocode address",geo_result_prefix:"Result",host:"Host",become_host:"Become a host"},
      ko:{nav_home:"Ìôà",nav_membership:"Î©§Î≤ÑÏã≠",nav_login:"Î°úÍ∑∏Ïù∏",logout:"Î°úÍ∑∏ÏïÑÏõÉ",my_page:"ÎßàÏù¥ÌéòÏù¥ÏßÄ",signed_in_as:"Î°úÍ∑∏Ïù∏ Í≥ÑÏ†ï",points:"Ìè¨Ïù∏Ìä∏",find_stays:"ÏàôÏÜå Ï∞æÍ∏∞",settings:"ÏÑ§Ï†ï",my_locations:"ÎÇ¥ ÏúÑÏπò Î¶¨Ïä§Ìä∏",my_bookings:"ÎÇ¥ ÏòàÏïΩ",no_bookings:"ÏïÑÏßÅ ÏòàÏïΩÏù¥ ÏóÜÏäµÎãàÎã§.",check_in:"Ï≤¥ÌÅ¨Ïù∏",check_out:"Ï≤¥ÌÅ¨ÏïÑÏõÉ",status:"ÏÉÅÌÉú",price:"Í≤∞Ï†úÍ∏àÏï°",payment_status:"Í≤∞Ï†ú",cancel:"ÏòàÏïΩ Ï∑®ÏÜå",cancel_requested:"Ï∑®ÏÜå ÏöîÏ≤≠Îê®",sign_in_prompt:"ÎßàÏù¥ÌéòÏù¥ÏßÄ Î≥¥Í∏∞Î•º ÏúÑÌï¥ Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî.",all_rights:"Î™®Îì† Í∂åÎ¶¨ Î≥¥Ïú†.",addr_placeholder:"Ï£ºÏÜå ÏûÖÎ†•",geo_btn:"Ï£ºÏÜå Ï¢åÌëú Î≥ÄÌôò",geo_result_prefix:"Í≤∞Í≥º",host:"Ìò∏Ïä§Ìä∏",become_host:"Ìò∏Ïä§Ìä∏ Ïã†Ï≤≠"},
      fr:{nav_home:"Accueil",nav_membership:"Abonnement",nav_login:"Connexion",logout:"D√©connexion",my_page:"Mon espace",signed_in_as:"Connect√© en tant que",points:"Points",find_stays:"Trouver des s√©jours",settings:"Param√®tres",my_locations:"Mes lieux",my_bookings:"Mes r√©servations",no_bookings:"Aucune r√©servation.",check_in:"Arriv√©e",check_out:"D√©part",status:"Statut",price:"Montant",payment_status:"Paiement",cancel:"Annuler",cancel_requested:"Annulation demand√©e",sign_in_prompt:"Veuillez vous connecter pour voir votre espace.",all_rights:"Tous droits r√©serv√©s.",addr_placeholder:"Saisir l'adresse",geo_btn:"G√©ocoder l'adresse",geo_result_prefix:"R√©sultat",host:"H√¥te",become_host:"Devenir h√¥te"},
      tr:{nav_home:"Ana sayfa",nav_membership:"√úyelik",nav_login:"Giri≈ü",logout:"√áƒ±kƒ±≈ü",my_page:"Hesabƒ±m",signed_in_as:"Olarak giri≈ü yapƒ±ldƒ±",points:"Puan",find_stays:"Konaklama bul",settings:"Ayarlar",my_locations:"Konumlarƒ±m",my_bookings:"Rezervasyonlarƒ±m",no_bookings:"Rezervasyon yok.",check_in:"Giri≈ü",check_out:"√áƒ±kƒ±≈ü",status:"Durum",price:"Tutar",payment_status:"√ñdeme",cancel:"ƒ∞ptal",cancel_requested:"ƒ∞ptal talep edildi",sign_in_prompt:"Sayfanƒ±zƒ± g√∂rmek i√ßin giri≈ü yapƒ±n.",all_rights:"T√ºm haklarƒ± saklƒ±dƒ±r.",addr_placeholder:"Adres girin",geo_btn:"Adresi jeokodla",geo_result_prefix:"Sonu√ß",host:"Ev sahibi",become_host:"Ev sahibi ol"},
      ja:{nav_home:"„Éõ„Éº„É†",nav_membership:"„É°„É≥„Éê„Éº„Ç∑„ÉÉ„Éó",nav_login:"„É≠„Ç∞„Ç§„É≥",logout:"„É≠„Ç∞„Ç¢„Ç¶„Éà",my_page:"„Éû„Ç§„Éö„Éº„Ç∏",signed_in_as:"„É≠„Ç∞„Ç§„É≥‰∏≠",points:"„Éù„Ç§„É≥„Éà",find_stays:"ÂÆøÊ≥äÂÖà„ÇíÊé¢„Åô",settings:"Ë®≠ÂÆö",my_locations:"„Éû„Ç§„É≠„Ç±„Éº„Ç∑„Éß„É≥",my_bookings:"‰∫àÁ¥Ñ‰∏ÄË¶ß",no_bookings:"‰∫àÁ¥Ñ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ",check_in:"„ÉÅ„Çß„ÉÉ„ÇØ„Ç§„É≥",check_out:"„ÉÅ„Çß„ÉÉ„ÇØ„Ç¢„Ç¶„Éà",status:"„Çπ„ÉÜ„Éº„Çø„Çπ",price:"ÈáëÈ°ç",payment_status:"ÊîØÊâï„ÅÑ",cancel:"„Ç≠„É£„É≥„Çª„É´",cancel_requested:"„Ç≠„É£„É≥„Çª„É´Áî≥Ë´ãÊ∏à„Åø",sign_in_prompt:"Ë°®Á§∫„Åô„Çã„Å´„ÅØ„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",all_rights:"ÁÑ°Êñ≠Ëª¢ËºâÁ¶ÅÊ≠¢„ÄÇ",addr_placeholder:"‰ΩèÊâÄ„ÇíÂÖ•Âäõ",geo_btn:"‰ΩèÊâÄ„Çí„Ç∏„Ç™„Ç≥„Éº„Éâ",geo_result_prefix:"ÁµêÊûú",host:"„Éõ„Çπ„Éà",become_host:"„Éõ„Çπ„Éà„Å´„Å™„Çã"},
      de:{nav_home:"Startseite",nav_membership:"Mitgliedschaft",nav_login:"Anmelden",logout:"Abmelden",my_page:"Mein Bereich",signed_in_as:"Angemeldet als",points:"Punkte",find_stays:"Unterk√ºnfte finden",settings:"Einstellungen",my_locations:"Meine Orte",my_bookings:"Meine Buchungen",no_bookings:"Keine Buchungen.",check_in:"Check-in",check_out:"Check-out",status:"Status",price:"Preis",payment_status:"Zahlung",cancel:"Stornieren",cancel_requested:"Stornierung angefordert",sign_in_prompt:"Zum Anzeigen bitte anmelden.",all_rights:"Alle Rechte vorbehalten.",addr_placeholder:"Adresse eingeben",geo_btn:"Adresse geokodieren",geo_result_prefix:"Ergebnis",host:"Host",become_host:"Host werden"},
      es:{nav_home:"Inicio",nav_membership:"Membres√≠a",nav_login:"Iniciar sesi√≥n",logout:"Cerrar sesi√≥n",my_page:"Mi cuenta",signed_in_as:"Conectado como",points:"Puntos",find_stays:"Buscar alojamientos",settings:"Configuraci√≥n",my_locations:"Mis ubicaciones",my_bookings:"Mis reservas",no_bookings:"Sin reservas.",check_in:"Check-in",check_out:"Check-out",status:"Estado",price:"Precio",payment_status:"Pago",cancel:"Cancelar",cancel_requested:"Cancelaci√≥n solicitada",sign_in_prompt:"Inicia sesi√≥n para ver tu cuenta.",all_rights:"Todos los derechos reservados.",addr_placeholder:"Introducir direcci√≥n",geo_btn:"Geocodificar direcci√≥n",geo_result_prefix:"Resultado",host:"Anfitri√≥n",become_host:"Hazte anfitri√≥n"},
      ru:{nav_home:"–ì–ª–∞–≤–Ω–∞—è",nav_membership:"–ü–æ–¥–ø–∏—Å–∫–∞",nav_login:"–í–æ–π—Ç–∏",logout:"–í—ã–π—Ç–∏",my_page:"–ú–æ–π –∫–∞–±–∏–Ω–µ—Ç",signed_in_as:"–í–æ—à–ª–∏ –∫–∞–∫",points:"–ë–∞–ª–ª—ã",find_stays:"–ù–∞–π—Ç–∏ –∂–∏–ª—å—ë",settings:"–ù–∞—Å—Ç—Ä–æ–π–∫–∏",my_locations:"–ú–æ–∏ –º–µ—Å—Ç–∞",my_bookings:"–ú–æ–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è",no_bookings:"–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –Ω–µ—Ç.",check_in:"–ó–∞–µ–∑–¥",check_out:"–í—ã–µ–∑–¥",status:"–°—Ç–∞—Ç—É—Å",price:"–°—É–º–º–∞",payment_status:"–û–ø–ª–∞—Ç–∞",cancel:"–û—Ç–º–µ–Ω–∏—Ç—å",cancel_requested:"–ó–∞–ø—Ä–æ—à–µ–Ω–∞ –æ—Ç–º–µ–Ω–∞",sign_in_prompt:"–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å.",all_rights:"–í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.",addr_placeholder:"–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å",geo_btn:"–ì–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å –∞–¥—Ä–µ—Å",geo_result_prefix:"–†–µ–∑—É–ª—å—Ç–∞—Ç",host:"–•–æ—Å—Ç",become_host:"–°—Ç–∞—Ç—å —Ö–æ—Å—Ç–æ–º"},
      it:{nav_home:"Home",nav_membership:"Abbonamento",nav_login:"Accedi",logout:"Esci",my_page:"Area personale",signed_in_as:"Collegato come",points:"Punti",find_stays:"Cerca alloggi",settings:"Impostazioni",my_locations:"Le mie posizioni",my_bookings:"Le mie prenotazioni",no_bookings:"Nessuna prenotazione.",check_in:"Check-in",check_out:"Check-out",status:"Stato",price:"Prezzo",payment_status:"Pagamento",cancel:"Annulla",cancel_requested:"Annullamento richiesto",sign_in_prompt:"Accedi per visualizzare.",all_rights:"Tutti i diritti riservati.",addr_placeholder:"Inserisci indirizzo",geo_btn:"Geocodifica indirizzo",geo_result_prefix:"Risultato",host:"Host",become_host:"Diventa host"},
      zh:{nav_home:"È¶ñÈ°µ",nav_membership:"‰ºöÂëò",nav_login:"ÁôªÂΩï",logout:"ÁôªÂá∫",my_page:"ÊàëÁöÑÈ°µÈù¢",signed_in_as:"ÁôªÂΩïÂ∏êÂè∑",points:"ÁßØÂàÜ",find_stays:"Êü•Êâæ‰ΩèÂÆø",settings:"ËÆæÁΩÆ",my_locations:"ÊàëÁöÑ‰ΩçÁΩÆ",my_bookings:"ÊàëÁöÑÈ¢ÑËÆ¢",no_bookings:"ÊöÇÊó†È¢ÑËÆ¢„ÄÇ",check_in:"ÂÖ•‰Ωè",check_out:"ÈÄÄÊàø",status:"Áä∂ÊÄÅ",price:"ÈáëÈ¢ù",payment_status:"ÊîØ‰ªò",cancel:"ÂèñÊ∂à",cancel_requested:"Â∑≤Áî≥ËØ∑ÂèñÊ∂à",sign_in_prompt:"ËØ∑ÁôªÂΩï‰ª•Êü•ÁúãÈ°µÈù¢„ÄÇ",all_rights:"ÁâàÊùÉÊâÄÊúâ„ÄÇ",addr_placeholder:"ËæìÂÖ•Âú∞ÂùÄ",geo_btn:"Âú∞ÂùÄÂú∞ÁêÜÁºñÁ†Å",geo_result_prefix:"ÁªìÊûú",host:"Êàø‰∏ú",become_host:"Êàê‰∏∫Êàø‰∏ú"}
    };
    function getLang(){ return localStorage.getItem('lang') || (navigator.language||'en').slice(0,2); }
    function setLang(lang){
      const pack = I18N[lang] || I18N.en;
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const k = el.getAttribute('data-i18n');
        if(pack[k]) el.textContent = pack[k];
      });
      const addr = document.getElementById('addrInput');
      if(addr){ addr.placeholder = pack.addr_placeholder || I18N.en.addr_placeholder; }
      document.documentElement.lang = lang;
      localStorage.setItem('lang', lang);
    }
  </script>

  <!-- App (Firebase + safe handlers) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ===== Utils: safe click & once =====
    function safeClick(btn, handler, {cooldownMs=600}={}){
      if(!btn) return;
      if(btn.dataset.bound) return; // prevent duplicate listeners
      btn.dataset.bound = "1";
      let inFlight = false;
      btn.addEventListener('click', async (ev)=>{
        if(inFlight || btn.disabled) return;
        inFlight = true;
        const prev = btn.textContent;
        btn.disabled = true;
        btn.setAttribute('aria-busy','true');
        try{
          await handler(ev, btn);
        }finally{
          setTimeout(()=>{ // brief cooldown to swallow double taps
            btn.disabled = false;
            btn.removeAttribute('aria-busy');
            btn.textContent = btn.dataset.restoreText || prev;
            inFlight = false;
          }, cooldownMs);
        }
      });
    }

    // ===== i18n init =====
    const langSelect = document.getElementById('langSelect');
    const initialLang = (()=>{ const l = getLang(); return I18N[l] ? l : 'en'; })();
    langSelect.value = initialLang; setLang(initialLang);
    langSelect.addEventListener('change', ()=> setLang(langSelect.value));

    // ===== Firebase =====
    const firebaseConfig = {
      apiKey: "AIzaSyCyb0pn2sFTEPkL0Q1ALwZaV2QILWyP_fk",
      authDomain: "stayworld-2570c.firebaseapp.com",
      projectId: "stayworld-2570c",
      storageBucket: "stayworld-2570c.firebasestorage.app",
      messagingSenderId: "272599681686",
      appId: "1:272599681686:web:33f89b66f7ee6f6f0b50b7",
      measurementId: "G-F8MXM3D7FJ"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // year
    document.getElementById('year').textContent = new Date().getFullYear();

    // header refs
    const loginLink   = document.getElementById('loginLink');
    const logoutBtn   = document.getElementById('logoutBtn');
    const hostLink    = document.getElementById('hostLink');
    const becomeHostLink = document.getElementById('becomeHostLink');

    const userLevel   = document.getElementById('userLevel');
    const userName    = document.getElementById('userName');
    const userEmail   = document.getElementById('userEmail');
    const userPoints  = document.getElementById('userPoints');

    // bookings / locations
    const bookingsList  = document.getElementById('bookingsList');
    const bookingsCount = document.getElementById('bookingsCount');
    const locationsCount= document.getElementById('locationsCount');

    // ===== Google Maps single-load (Promise singleton) =====
    let _gmapsPromise;
    function getGoogleMaps(){
      if(window.google?.maps) return Promise.resolve();
      if(_gmapsPromise) return _gmapsPromise;
      const apiKey = 'YOUR_GOOGLE_MAPS_KEY'; // TODO: AIzaSyDRUf7RDA9P7Iy8qyyDoAkvVtbouEEzwRY
      if(!apiKey || apiKey.includes('YOUR_')){
        console.warn('Google Maps API key missing');
        return Promise.resolve();
      }
      _gmapsPromise = new Promise((resolve, reject)=>{
        const cbName = '__mapsInit_'+Math.random().toString(36).slice(2);
        window[cbName] = ()=>{ resolve(); delete window[cbName]; };
        const s=document.createElement('script');
        s.src=`https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=${cbName}`;
        s.async=true; s.defer=true;
        s.onerror = (e)=>{ reject(e); };
        document.head.appendChild(s);
      });
      return _gmapsPromise;
    }

    // map helpers
    let map, markers=[];
    function ensureMap(center={lat:39.0,lng:35.0}){
      if(map || !window.google?.maps) return;
      map = new google.maps.Map(document.getElementById('map'), {center, zoom:5});
    }
    function clearMarkers(){ markers.forEach(m=>m.setMap(null)); markers=[]; }

    // ===== Level logic =====
    function computeLevel(points){
      if(points>=15000000) return 'Elite';
      if(points>=7500000)  return 'Diamond';
      if(points>=4000000)  return 'Platinum';
      if(points>=2000000)  return 'Gold';
      if(points>=500000)   return 'Silver';
      return 'Bronze';
    }

    // ===== Firestore: bookings =====
    async function fetchUserBookings(uid){
      const qRef = query(collection(db,'bookings'), where('user_id','==', uid));
      const snap = await getDocs(qRef);
      return snap.docs.map(d=>({ id:d.id, ...d.data() }));
    }

    function renderBookings(list, lang){
      const pack = I18N[lang]||I18N.en;
      bookingsList.innerHTML = '';
      if(!list.length){
        const div = document.createElement('div');
        div.className='empty';
        div.innerHTML = `üóÇÔ∏è <span>${pack.no_bookings}</span>`;
        bookingsList.appendChild(div);
        bookingsCount.textContent='0';
        locationsCount.textContent='0';
        return;
      }
      bookingsCount.textContent = String(list.length);

      const locs = list
        .map(b=>({ lat:b?.location?.lat, lng:b?.location?.lng, name:b?.listing_title || 'Stay', id:b.id }))
        .filter(x=>typeof x.lat==='number' && typeof x.lng==='number');

      locationsCount.textContent = String(locs.length);

      if(locs.length){
        getGoogleMaps().then(()=>{
          if(window.google?.maps){
            ensureMap({lat:locs[0].lat, lng:locs[0].lng});
            clearMarkers();
            const bounds = new google.maps.LatLngBounds();
            locs.forEach(l=>{
              const m = new google.maps.Marker({position:{lat:l.lat,lng:l.lng}, map, title:l.name});
              markers.push(m);
              bounds.extend({lat:l.lat,lng:l.lng});
            });
            if(locs.length>1) map.fitBounds(bounds); else map.setZoom(12);
          }
        });
      }

      list.forEach(b=>{
        const item = document.createElement('div');
        item.className='booking';

        const thumb = document.createElement('img');
        thumb.className='thumb';
        thumb.alt=b.listing_title||'Stay';
        thumb.src=b.thumbUrl||'/placeholder-stay.jpg';

        const main = document.createElement('div');
        const title = document.createElement('div');
        title.style.fontWeight='700';
        title.textContent = b.listing_title || 'Stay';

        const meta = document.createElement('div');
        meta.className='muted';
        meta.innerHTML = `${pack.check_in}: <b>${b.check_in||'-'}</b> ¬∑ ${pack.check_out}: <b>${b.check_out||'-'}</b>`;

        const meta2 = document.createElement('div');
        meta2.className='muted';
        const priceTxt = (typeof b.price_total!=='undefined')
          ? `${b.price_total}${b.currency||''}${b.refund_amount?` ¬∑ refund: ${b.refund_amount}${b.currency||''}`:''}`
          : '-';
        meta2.innerHTML = `${pack.status}: <b>${b.status||'-'}</b> ¬∑ ${pack.price}: <b>${priceTxt}</b>`;

        main.appendChild(title); main.appendChild(meta); main.appendChild(meta2);

        const actions = document.createElement('div');
        const cancelBtn = document.createElement('button');
        cancelBtn.className='btn danger';
        cancelBtn.textContent = pack.cancel;
        cancelBtn.disabled = b.status === 'canceled';

        // Ï§ëÎ≥µ Ï∑®ÏÜå Í∞ÄÎìú
        safeClick(cancelBtn, async ()=>{
          if(cancelBtn.dataset.busy==="1") return;
          if(!confirm(pack.cancel+'?')) return;
          cancelBtn.dataset.busy="1";
          cancelBtn.dataset.restoreText = cancelBtn.textContent;
          cancelBtn.textContent = pack.cancel_requested;
          try{
            await updateDoc(doc(db,'bookings', b.id), { status:'canceled' });
            cancelBtn.disabled = true;
            item.style.opacity=.85;
          }catch(e){
            alert('Cancel failed: '+e.message);
            cancelBtn.textContent = cancelBtn.dataset.restoreText || pack.cancel;
            cancelBtn.dataset.busy="0";
          }
        }, {cooldownMs:800});

        actions.appendChild(cancelBtn);
        item.appendChild(thumb); item.appendChild(main); item.appendChild(actions);
        bookingsList.appendChild(item);
      });
    }

    // ===== Geocode (Ï£ºÏÜå‚ÜíÏ¢åÌëú) =====
    async function geocodeAddress(address){
      if(!address) throw new Error('Empty address');
      await getGoogleMaps();
      if(!window.google?.maps) throw new Error('Maps not available');
      return new Promise((resolve, reject)=>{
        try{
          const geocoder = new google.maps.Geocoder();
          geocoder.geocode({ address }, (results, status)=>{
            if(status==='OK' && results?.[0]){
              const loc = results[0].geometry.location;
              resolve({ lat: loc.lat(), lng: loc.lng(), formatted: results[0].formatted_address });
            }else{
              reject(new Error('Geocode failed: '+status));
            }
          });
        }catch(e){ reject(e); }
      });
    }

    // ===== Buttons: safe attach =====
    const geoBtn   = document.getElementById('geoBtn');
    const addrInput= document.getElementById('addrInput');
    const geoOut   = document.getElementById('geoResult');

    safeClick(geoBtn, async (_ev, btn)=>{
      const lang = langSelect.value || getLang();
      const pack = I18N[lang] || I18N.en;
      const q = (addrInput?.value||'').trim();
      geoOut.textContent = '';
      btn.dataset.restoreText = btn.textContent;
      btn.textContent = '‚Ä¶';
      try{
        const r = await geocodeAddress(q);
        geoOut.textContent = `${pack.geo_result_prefix}: ${r.lat}, ${r.lng} (${r.formatted})`;
        // ÏßÄÎèÑÏóê ÌëúÏãú
        if(window.google?.maps){
          ensureMap({lat:r.lat,lng:r.lng});
          clearMarkers();
          const m = new google.maps.Marker({position:{lat:r.lat,lng:r.lng}, map, title:r.formatted});
          markers.push(m);
          map.setCenter({lat:r.lat,lng:r.lng});
          map.setZoom(13);
        }
      }catch(e){
        geoOut.textContent = 'Geocode error: '+ e.message;
      }
    }, {cooldownMs:700});

    // ===== Auth state =====
    onAuthStateChanged(auth, async (user)=>{
      const lang = langSelect.value || getLang();

      // Í∏∞Î≥∏ ÌÜ†Í∏Ä Ï¥àÍ∏∞Ìôî
      hostLink.style.display = 'none';
      becomeHostLink.style.display = 'none';

      if(!user){
        userName.textContent='‚Äî';
        userEmail.textContent= I18N[lang]?.sign_in_prompt || I18N.en.sign_in_prompt;
        loginLink.style.display='inline-flex';
        logoutBtn.style.display='none';
        renderBookings([], lang);
        return;
      }
      loginLink.style.display='none';
      logoutBtn.style.display='inline-flex';
      userName.textContent = user.displayName || 'Guest';
      userEmail.textContent = user.email || '';

      // ‚úÖ Ïó≠Ìï† ÌôïÏù∏ ÌõÑ Î≤ÑÌäº ÌÜ†Í∏Ä
      try {
        const snap = await getDoc(doc(db, 'users', user.uid));
        const role = snap.exists() ? (snap.data().role || 'guest') : 'guest';
        if (role === 'host') {
          hostLink.style.display = 'inline-flex';
          becomeHostLink.style.display = 'none';
        } else {
          hostLink.style.display = 'none';
          becomeHostLink.style.display = 'inline-flex';
        }
      } catch (e) {
        console.warn('role check failed', e);
        hostLink.style.display = 'none';
        becomeHostLink.style.display = 'none';
      }

      try{
        const list = await fetchUserBookings(user.uid);
        const points = list.reduce((s,b)=> s + (Number(b.pointsEarned)||0), 0);
        userPoints.textContent = String(points);
        userLevel.textContent  = computeLevel(points);
        renderBookings(list, lang);
      }catch(e){
        console.error(e);
        renderBookings([], lang);
      }
    });

    // logout: Ï§ëÎ≥µ ÌÅ¥Î¶≠ Í∞ÄÎìú
    safeClick(logoutBtn, async ()=>{
      await signOut(auth);
    }, {cooldownMs:600});
  </script>
</body>
</html>
