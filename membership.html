/* ============================
   STAYWORLD Membership Logic (6 tiers) â€” hardened
   - Higher tier inherits lower-tier benefits
   - Level by total spent (KRW)
   - Auto downgrade 1 level if no booking >= 60 days
   - Auto highlight current tier + progress gauge update
   - Downgrade alerts at D-30, D-15, D-7, D-1
   - i18n messages (EN/KR ê¸°ë³¸) + fallback
   - Elite tier can be manual-only (config)
   ============================ */

(function(){
  /* ---------- CONFIG ---------- */
  const LEVELS = [
    { name:'Bronze',   min:       0, rate: 0  },
    { name:'Silver',   min:  500_000, rate: 3  },
    { name:'Gold',     min:2_000_000, rate: 5  },
    { name:'Platinum', min:4_000_000, rate: 7  },
    { name:'Diamond',  min:7_500_000, rate:10  },
    { name:'Elite',    min:15_000_000, rate:15, manual:true } // manual ìŠ¹ê¸‰(ê¸°ë³¸)
  ];
  const DOWNGRADE_DAYS = 60;

  // ë©”ì‹œì§€ i18n (í•„ìš” ì‹œ í™•ì¥)
  const MSG = {
    en:{
      toNext:(rem)=>`â‚©${rem.toLocaleString('ko-KR')} to next tier. Auto-downgrade by 1 level after 60 days of no bookings.`,
      top: `Top tier (Elite). Auto-downgrade by 1 level after 60 days of no bookings.`,
      d30:'ğŸ“¢ Auto downgrade in 30 days. Keep your tier by booking.',
      d15:'âš ï¸ Auto downgrade in 15 days. Stay active.',
      d7 :'â³ Auto downgrade in 7 days. Book soon!',
      d1 :'ğŸš¨ Auto downgrade tomorrow! Complete a booking today.'
    },
    ko:{
      toNext:(rem)=>`ë‹¤ìŒ ë“±ê¸‰ê¹Œì§€ â‚©${rem.toLocaleString('ko-KR')} ë‚¨ì•˜ì–´ìš”. 60ì¼ ì˜ˆì•½ ì—†ìœ¼ë©´ ìë™ 1ë‹¨ê³„ ê°•ë“±.`,
      top: `ìµœìƒìœ„ ë“±ê¸‰(Elite). 60ì¼ ì˜ˆì•½ ì—†ìœ¼ë©´ ìë™ 1ë‹¨ê³„ ê°•ë“±.`,
      d30:'ğŸ“¢ 30ì¼ í›„ ìë™ ê°•ë“± ì˜ˆì •ì…ë‹ˆë‹¤. ì§€ê¸ˆ ì˜ˆì•½í•˜ë©´ ìœ ì§€ë©ë‹ˆë‹¤.',
      d15:'âš ï¸ 15ì¼ í›„ ìë™ ê°•ë“± ì˜ˆì •ì…ë‹ˆë‹¤. í™œë™ì„ ìœ ì§€í•˜ì„¸ìš”.',
      d7 :'â³ 7ì¼ í›„ ìë™ ê°•ë“± ì˜ˆì •ì…ë‹ˆë‹¤. ì„œë‘˜ëŸ¬ ì˜ˆì•½í•˜ì„¸ìš”!',
      d1 :'ğŸš¨ ë‚´ì¼ ìë™ ê°•ë“±ë©ë‹ˆë‹¤! ì˜¤ëŠ˜ ì˜ˆì•½ì„ ì™„ë£Œí•˜ì„¸ìš”.'
    }
  };

  function currentLang(){
    // headerì˜ <select id="lang"> ë˜ëŠ” localStorage(sw_lang) í™•ì¸
    const sel = document.getElementById('lang');
    const code = (sel?.value || localStorage.getItem('sw_lang') || 'EN').toLowerCase();
    return code.startsWith('ko') ? 'ko' : 'en';
  }

  /* ---------- HELPERS ---------- */
  function $(sel, scope){ return (scope||document).querySelector(sel); }
  function $all(sel, scope){ return Array.from((scope||document).querySelectorAll(sel)); }

  // ê²Œì´ì§€/í…ìŠ¤íŠ¸ìš© ë‹¤ì¤‘ ì…€ë ‰í„°(ë””ìì¸ ë°”ë€Œì–´ë„ ìµœëŒ€í•œ ì°¾ì•„ì¤Œ)
  function findGaugeElements(){
    // ìš°ì„ ìˆœìœ„: ëª…ì‹œì  ID â†’ ë„ë¦¬ ì“°ëŠ” êµ¬ì¡° â†’ Tailwind ìœ ì‚¬ êµ¬ì¡°
    const gaugeBar = $('#levelGaugeBar')
      || $('.card .bg-[var(--gold)].h-2')
      || ($('.w-full.bg-white\\/10.rounded-full.h-2')?.querySelector('.h-2'))
      || $('#levelGauge .bar')
      || $('.level-gauge .bar');

    const gaugePctEl = $('#levelGaugePct')
      || $('.text-right.text-xs.text-white\\/60.mt-1')
      || $('.level-gauge .pct');

    const tierText = $('#levelProgressText')
      || $('#levelProgress .text')
      || $('.level-progress-text');

    return { gaugeBar, gaugePctEl, tierText };
  }

  function findTierCards(){
    // data-tier ì†ì„± ì¹´ë“œ (ê¶Œì¥). ì—†ìœ¼ë©´ íƒ€ì´í‹€ í…ìŠ¤íŠ¸ë¡œ ì¶”ì •
    const grid = $('#tiersGrid') || document;
    const cards = $all('[data-tier]', grid);
    if (cards.length) return cards;
    // Fallback: ì¹´ë“œ ì•ˆ h3/h4 í…ìŠ¤íŠ¸ì— ë“±ê¸‰ëª… í¬í•¨ëœ ìš”ì†Œë“¤ ì¶”ì •
    return $all('.card, [class*=tier], .membership-card', grid)
      .filter(card=>{
        const t = (card.textContent||'').toLowerCase();
        return LEVELS.some(l=> t.includes(l.name.toLowerCase()));
      });
  }

  function krw(n){ return new Intl.NumberFormat('ko-KR', { style:'currency', currency:'KRW', maximumFractionDigits:0 }).format(n); }

  /* ---------- CORE CALCS ---------- */
  /** Compute level index (considers manual-only Elite) */
  function computeLevel(totalSpentKRW, lastBookingISO, opts={}){
    const { eliteGranted=false } = opts;
    let base = 0;
    for (let i=0;i<LEVELS.length;i++){
      // Eliteê°€ manualì´ë©´ ì ìˆ˜ë§Œìœ¼ë¡œëŠ” ë“¤ì–´ê°€ì§€ ì•Šë„ë¡
      if (LEVELS[i].manual && !eliteGranted) continue;
      if (totalSpentKRW >= LEVELS[i].min) base = i;
    }
    if (lastBookingISO){
      const last = new Date(lastBookingISO);
      if (!Number.isNaN(+last)){
        const diffDays = Math.floor((Date.now() - last.getTime())/86400000);
        if (diffDays >= DOWNGRADE_DAYS) base = Math.max(0, base - 1);
      }
    }
    return base;
  }

  /** KRW remaining to next level; null if at top (reachable) */
  function remainingToNext(totalSpentKRW, levelIdx, eliteReachable){
    const topReachableIdx = (eliteReachable ? LEVELS.length-1 : LEVELS.length-2);
    if (levelIdx >= topReachableIdx) return null;
    const nextMin = LEVELS[levelIdx+1].min;
    return Math.max(0, nextMin - totalSpentKRW);
  }

  /* ---------- UI UPDATE ---------- */
  function applyLevelUI(levelIdx, totalSpentKRW, opts={}){
    const { eliteGranted=false } = opts;
    const lang = currentLang();
    const T = MSG[lang]||MSG.en;
    const lvl = LEVELS[levelIdx];

    // ê²Œì´ì§€/í…ìŠ¤íŠ¸
    const { gaugeBar, gaugePctEl, tierText } = findGaugeElements();

    // ì§„í–‰ë¥  ê³„ì‚°
    let pct = 100;
    const rem = remainingToNext(totalSpentKRW, levelIdx, eliteGranted || !LEVELS[levelIdx+1]?.manual);
    if (rem !== null){
      const currMin = LEVELS[levelIdx].min;
      const nextMin = LEVELS[levelIdx+1].min;
      pct = Math.round(((totalSpentKRW - currMin) / Math.max(1,(nextMin - currMin))) * 100);
      pct = Math.max(0, Math.min(100, pct));
      if (tierText) tierText.textContent = T.toNext(rem);
    } else {
      if (tierText) tierText.textContent = T.top;
    }
    if (gaugeBar) gaugeBar.style.width = pct + '%';
    if (gaugePctEl) gaugePctEl.textContent = pct + '%';

    // íˆì–´ë¡œ/ìš”ì•½ íƒ€ì´í‹€ (ê°€ëŠ¥í•˜ë©´ ê°±ì‹ )
    const heroTitle = $all('h3.text-xl.font-bold, .your-tier-title, #yourTierTitle')[0];
    if (heroTitle){
      heroTitle.innerHTML = `${lvl.name.toUpperCase()} <span class="text-brand gold">${lvl.rate}% back</span>`;
    }

    // ë©¤ë²„ì‹­ ì¹´ë“œ í•˜ì´ë¼ì´íŠ¸
    const cards = findTierCards();
    cards.forEach(card=>{
      // ìŠ¤íƒ€ì¼ í´ë˜ìŠ¤ í†µì¼
      card.classList.remove('tier-active','tier-muted');
      const name = card.getAttribute('data-tier') || (card.querySelector('h3,h4')?.textContent||'').trim();
      const idx = LEVELS.findIndex(x=> name.toLowerCase().includes(x.name.toLowerCase()));
      if (idx === -1) return;
      if (idx === levelIdx) card.classList.add('tier-active');
      if (idx > levelIdx)  card.classList.add('tier-muted');
      // ì ‘ê·¼ì„±: í˜„ì¬ ë“±ê¸‰ aria í‘œì‹œ
      if (idx === levelIdx) card.setAttribute('aria-current','true'); else card.removeAttribute('aria-current');
    });

    // ì§„í–‰ ìƒíƒœ ì´ë²¤íŠ¸(í•„ìš”ì‹œ ë‹¤ë¥¸ ëª¨ë“ˆì—ì„œ ë“£ê²Œ)
    document.dispatchEvent(new CustomEvent('membership:updated', {
      detail:{ levelIndex:levelIdx, level:lvl, totalSpentKRW, pct, remaining:rem }
    }));
  }

  /* ---------- Alerts ---------- */
  function showDowngradeAlert(daysLeft){
    const lang = currentLang();
    const T = MSG[lang]||MSG.en;
    const map = {30:T.d30, 15:T.d15, 7:T.d7, 1:T.d1};
    const msg = map[daysLeft];
    if (!msg) return;

    const alertEl = document.createElement('div');
    alertEl.className = "fixed bottom-5 right-5 bg-red-600 text-white px-4 py-3 rounded-xl shadow-lg z-50";
    alertEl.textContent = msg;
    document.body.appendChild(alertEl);
    setTimeout(()=> alertEl.remove(), 8000);
  }

  /* ---------- Public API ---------- */
  /**
   * setUserContext
   * @param {Object} ctx
   * @param {number} ctx.totalSpentKRW - ëˆ„ì  ê²°ì œì•¡(ì›)
   * @param {string} [ctx.lastBookingISO] - ë§ˆì§€ë§‰ ì˜ˆì•½ ISO ë‚ ì§œ ë¬¸ìì—´
   * @param {boolean} [ctx.eliteGranted] - ì—˜ë¦¬íŠ¸ ìˆ˜ë™ ìŠ¹ê¸‰ ê¶Œí•œ (ìš´ì˜ì ìˆ˜ë™ ì„¤ì •)
   */
  function setUserContext({ totalSpentKRW, lastBookingISO, eliteGranted=false }){
    const idx = computeLevel(totalSpentKRW||0, lastBookingISO, { eliteGranted });
    applyLevelUI(idx, totalSpentKRW||0, { eliteGranted });

    if (lastBookingISO){
      const d = new Date(lastBookingISO);
      if (!Number.isNaN(+d)){
        const diffDays = Math.floor((Date.now() - d.getTime())/86400000);
        const daysLeft = DOWNGRADE_DAYS - diffDays;
        if ([30,15,7,1].includes(daysLeft)) showDowngradeAlert(daysLeft);
      }
    }
  }

  // ì „ì—­ ë…¸ì¶œ (ë‹¤ë¥¸ í˜ì´ì§€/ëª¨ë“ˆì—ì„œ í˜¸ì¶œ)
  window.StayWorldMembership = {
    LEVELS, DOWNGRADE_DAYS,
    computeLevel, setUserContext, applyLevelUI
  };

  /* ===== Demo hook: remove/disable in production ===== */
  (function demo(){
    if (window.ENV?.DEMO_MODE){
      setUserContext({
        totalSpentKRW: 3_250_000,                                     // ëˆ„ì  ê²°ì œì•¡
        lastBookingISO: new Date(Date.now()-20*86400000).toISOString(), // ë§ˆì§€ë§‰ ì˜ˆì•½: 20ì¼ ì „
        eliteGranted:false
      });
    }
  })();
})();
