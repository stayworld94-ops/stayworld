<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>StayWorld — Membership</title>
  <link rel="icon" href="/favicon.ico" />
  <style>
    :root{
      --bg:#0b0f14; --card:#121822; --muted:#99a3b3; --text:#e7ecf3; --gold:#f3c04b; --accent:#4da3ff; --ok:#19c37d;
    }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:15px/1.5 system-ui,Segoe UI,Arial}
    a{color:inherit;text-decoration:none}
    .container{max-width:1100px;margin:0 auto;padding:20px}
    header.site-header{border-bottom:1px solid #1c2330;position:sticky;top:0;background:rgba(11,15,20,.9);backdrop-filter:saturate(140%) blur(6px);z-index:10}
    .header-row{display:flex;align-items:center;gap:16px;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .brand-logo{height:28px}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#172133;color:var(--muted);font-size:12px}

    .hero{padding:32px 0 8px}
    h1{margin:0;font-size:28px}
    .sub{color:var(--muted);margin-top:6px}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .card{background:var(--card);border:1px solid #1c2330;border-radius:14px;padding:18px}
    .card h2{margin:0 0 10px 0;font-size:18px}
    .muted{color:var(--muted)}
    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}

    /* Plans */
    .plans-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .pill{display:inline-flex;border:1px solid #233047;border-radius:999px;overflow:hidden}
    .pill button{background:transparent;color:var(--text);border:0;padding:8px 14px;cursor:pointer}
    .pill button.active{background:#233047}
    select{appearance:none;background:#0f141c;border:1px solid #233047;color:var(--text);border-radius:10px;padding:8px 12px}

    .plan-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .plan{border:1px solid #233047;border-radius:12px;padding:16px}
    .price{font-size:22px;font-weight:700;margin:8px 0 12px}
    .small{font-size:12px;color:var(--muted)}
    .cta{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid #2b3850;cursor:pointer}
    .cta:hover{background:#182132}

    /* Usage */
    .usage .kv{display:grid;grid-template-columns:140px 1fr;gap:8px;margin:8px 0}
    .ok{color:var(--ok)}

    /* Levels */
    .gauge{height:8px;background:#1b2332;border-radius:999px;overflow:hidden}
    .gauge > i{display:block;height:100%;width:0;background:linear-gradient(90deg,#3e9cff,#80d0ff)}

    /* Tiers */
    #tiersGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-top:14px}
    .tier-card{border:1px solid #233047;border-radius:12px;padding:16px}
    .tier-card h3{margin:0 0 6px 0}
    .benefit{display:flex;gap:8px;margin:6px 0;color:#ccdae9}
    .benefit i{opacity:.6}
    @media (max-width:900px){ .grid,.plan-grid{grid-template-columns:1fr} #tiersGrid{grid-template-columns:1fr 1fr} }
    @media (max-width:600px){ #tiersGrid{grid-template-columns:1fr} }

    /* Checkout modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
    .modal .sheet{background:var(--card);border:1px solid #233047;border-radius:14px;max-width:520px;width:100%;padding:18px}
    .modal .row-end{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid #2b3850;background:#182132;color:#e7ecf3;cursor:pointer}
    .btn:hover{filter:brightness(1.1)}
  </style>
</head>
<body>

  <!-- Header -->
  <header class="site-header">
    <div class="container header-row">
      <a class="brand" href="/"><img class="brand-logo" src="/stayworld-logo.png" alt="StayWorld"><span>STAYWORLD</span></a>
      <div class="row">
        <a href="/membership.html" class="badge" data-i18n="ui_membership">Membership</a>
        <a href="/login.html" class="badge" data-i18n="ui_login">Login</a>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Title -->
    <section class="hero">
      <div class="badge" id="dwTop" data-i18n="ui_membership">Membership</div>
      <h1 id="mb_title" data-i18n="ui_title">Membership + Levels</h1>
      <div class="sub" id="mb_subtitle" data-i18n="ui_subtitle">Choose a plan. Perks and level progress update automatically.</div>
    </section>

    <div class="grid">
      <!-- LEFT: Plans / Prices -->
      <section class="card">
        <div class="plans-head">
          <h2 id="plansHeader" data-i18n="ui_plans">Membership Plans</h2>
          <div class="row">
            <div class="pill">
              <button id="billMonthly" class="active" data-i18n="ui_monthly">Monthly</button>
              <button id="billYearly" data-i18n="ui_yearly">Yearly</button>
            </div>
            <select id="currencySelect" title="Currency">
              <option>USD</option><option>EUR</option><option>GBP</option><option>JPY</option><option>KRW</option>
              <option>TRY</option><option>CNY</option><option>MXN</option><option>BRL</option><option>RUB</option>
              <option>AUD</option><option>CAD</option>
            </select>
          </div>
        </div>

        <div class="plan-grid">
          <div class="plan" id="planPlus">
            <div class="badge">StayWorld+ (Plus)</div>
            <div class="price" id="pricePlus">$9.99 / mo</div>
            <div class="small muted" data-i18n="ui_plus_desc">Instant perks + monthly boosts</div>
            <div style="margin-top:10px"><button class="cta" data-plan="plus" data-i18n="ui_start_plus">Start Plus</button></div>
          </div>

          <div class="plan" id="planBlack">
            <div class="badge" style="background:#2a1f09;color:#f3c04b;border:1px solid #3b2a0a">StayWorld Black</div>
            <div class="price" id="priceBlack">$24.99 / mo</div>
            <div class="small muted" data-i18n="ui_black_desc">More boosts + priority + extras</div>
            <div style="margin-top:10px"><button class="cta" data-plan="black" data-i18n="ui_start_black">Start Black</button></div>
          </div>
        </div>
      </section>

      <!-- RIGHT: Your benefits / progress -->
      <section class="card usage">
        <h2 data-i18n="ui_your_membership">Your Membership</h2>

        <div class="kv"><div id="lbl_perksLeft" data-i18n="ui_this_month">This month remaining</div><div id="uiPerksLeft">—</div></div>
        <div class="kv"><div id="lbl_boostLeft" data-i18n="ui_points_boost">Points boost</div><div id="uiBoostLeft">—</div></div>

        <div class="kv">
          <div id="lbl_discountLeft" data-i18n="ui_instant_discount">Instant discount</div>
          <div><span id="uiDiscountPerBooking">—</span> <span class="muted" id="lbl_bookings" data-i18n="ui_per_booking">per booking</span></div>
        </div>

        <div class="kv"><div id="lbl_ticketsEligible" data-i18n="ui_tickets">Tickets</div><div id="uiTicketsEligible" class="ok">—</div></div>

        <div style="margin-top:14px">
          <div class="row"><div id="levelTitle" data-i18n="ui_your_level">Your Level</div><div class="badge" id="tierBadge">0% back</div></div>
          <div class="small muted" id="lbl_nextLevel" data-i18n="ui_next_level" style="margin-top:6px">Next level</div>
          <div class="gauge" style="margin:8px 0 4px"><i id="nextLevelGaugeFill"></i></div>
          <div class="row small"><span id="nextLevelLine">—</span><span class="badge" id="nextLevelPct">0%</span></div>

          <div class="small muted" style="margin-top:12px" data-i18n="ui_overall_progress">Overall progress</div>
          <div class="gauge" style="margin:8px 0 4px"><i id="gaugeFill"></i></div>
          <div class="row small"><span id="progressPct">0%</span></div>
        </div>
      </section>
    </div>

    <!-- Tier benefits (stacked) -->
    <section class="card" style="margin-top:16px">
      <div class="row" style="justify-content:space-between">
        <h2 class="row" style="gap:8px">
          <span data-i18n="ui_levels">Levels</span>
          <span class="badge" id="inheritNote" data-i18n="ui_inherit_note">Higher tiers include all lower-level benefits.</span>
        </h2>
      </div>

      <div id="tiersGrid">
        <div class="tier-card" data-tier="Bronze"><h3>Bronze</h3><div class="benefits"></div></div>
        <div class="tier-card" data-tier="Silver"><h3>Silver</h3><div class="benefits"></div></div>
        <div class="tier-card" data-tier="Gold"><h3>Gold</h3><div class="benefits"></div></div>
        <div class="tier-card" data-tier="Platinum"><h3>Platinum</h3><div class="benefits"></div></div>
        <div class="tier-card" data-tier="Diamond"><h3>Diamond</h3><div class="benefits"></div></div>
        <div class="tier-card" data-tier="Elite"><h3>Elite</h3><div class="benefits"></div></div>
      </div>
    </section>
  </main>

  <!-- Checkout Modal -->
  <div class="modal" id="checkoutModal" aria-hidden="true">
    <div class="sheet">
      <h3 id="co_title" data-i18n="ui_checkout">Checkout</h3>
      <div class="small muted" id="co_planLine">—</div>

      <div style="margin-top:12px">
        <label class="small muted">Amount</label>
        <div id="co_amount" style="font-weight:700;font-size:18px;margin-top:4px">—</div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnCrypto" data-i18n="ui_pay_crypto">Pay with Crypto</button>
        <div id="paypal-container"></div>
      </div>
      <p id="payMsg" class="small muted" style="margin-top:8px"></p>

      <div class="row-end">
        <button class="btn" id="btnClose">Close</button>
      </div>
    </div>
  </div>

  <!-- i18n: 반드시 결제 스크립트보다 먼저 로드 -->
  <script src="/assets/js/lang.js?v=20250902"></script>

  <!-- PayPal SDK: 실제 CLIENT_ID 로 교체 -->
  <script src="https://www.paypal.com/sdk/js?client-id=REPLACE_WITH_CLIENT_ID"></script>

  <script>
  /***** CONFIG *****/
  const SUCCESS_URL = "https://stayworldbooking.com/payment-success.html";
  const CANCEL_URL  = "https://stayworldbooking.com/payment-cancel.html";

  // 표시용 단순 환율 (운영 시 주기적 업데이트 권장, 기준통화: USD)
  const FX_RATES = {
    USD: 1, EUR: 0.92, GBP: 0.78, JPY: 149, KRW: 1370, TRY: 34, CNY: 7.1, MXN: 19, BRL: 5.5, RUB: 90, AUD: 1.5, CAD: 1.36
  };

  // 멤버십 가격(USD 기준)
  const PRICING = {
    plus:   { monthly: 9.99,  yearly: 99.00 },
    black:  { monthly: 24.99, yearly: 249.00 }
  };

  // 레벨 임계값(기준: KRW 총 누적 결제액)
  const LEVELS_KRW = {
    bronze: 0,
    silver: 500000,
    gold: 2000000,
    platinum: 4000000,
    diamond: 7500000,
    elite: 15000000
  };

  // 혜택 키 (문구는 lang.js가 관리)
  const BENEFIT_KEYS = {
    bronze:   ["benefit_basic"],
    silver:   ["benefit_silver_3"],
    gold:     ["benefit_gold_5", "benefit_priority"],
    platinum: ["benefit_platinum_7", "benefit_platinum_season"],
    diamond:  ["benefit_diamond_10", "benefit_diamond_coupon", "benefit_diamond_support"],
    elite:    ["benefit_elite_private", "benefit_elite_emergency"]
  };

  const $$ = s => document.querySelector(s);
  const $$$ = s => document.querySelectorAll(s);

  const currencySel = $("#currencySelect");
  const billMonthly = $("#billMonthly");
  const billYearly  = $("#billYearly");
  const pricePlus   = $("#pricePlus");
  const priceBlack  = $("#priceBlack");

  const levelTitle  = $("#levelTitle");
  const tierBadge   = $("#tierBadge");
  const nextFill    = $("#nextLevelGaugeFill");
  const nextLine    = $("#nextLevelLine");
  const nextPct     = $("#nextLevelPct");
  const gaugeFill   = $("#gaugeFill");
  const progressPct = $("#progressPct");

  const tiersGrid   = $("#tiersGrid");

  // Checkout modal els
  const modal       = $("#checkoutModal");
  const co_title    = $("#co_title");
  const co_planLine = $("#co_planLine");
  const co_amount   = $("#co_amount");
  const btnCrypto   = $("#btnCrypto");
  const payMsg      = $("#payMsg");
  const btnClose    = $("#btnClose");

  // 유틸
  function $(id){ return document.getElementById(id.replace('#','')); }
  function fmtCurrency(amount, cur){
    const locale = cur === 'KRW' ? 'ko-KR'
                 : cur === 'JPY' ? 'ja-JP'
                 : cur === 'TRY' ? 'tr-TR'
                 : cur === 'EUR' ? 'fr-FR'
                 : 'en-US';
    return new Intl.NumberFormat(locale, { style:'currency', currency:cur }).format(amount);
  }
  function usdTo(amountUSD, cur){
    const r = FX_RATES[cur] || 1;
    return amountUSD * r;
  }
  function krwTo(amountKRW, cur){
    // KRW → USD → target
    const usd = amountKRW / FX_RATES.KRW;
    return usdTo(usd, cur);
  }

  // 가짜 사용자 누적 결제액(데모) — 운영 시 서버/DB 값으로 채우세요.
  let userSpentKRW = 0;

  function currentLevelByKRW(spent){
    const order = ["elite","diamond","platinum","gold","silver","bronze"];
    for (const lv of order){
      if (spent >= LEVELS_KRW[lv]) return lv;
    }
    return "bronze";
  }

  function cap(s){ return s.charAt(0).toUpperCase()+s.slice(1); }

  // % back i18n
  function percentBack(level){
    const map = { bronze:"back_0", silver:"back_3", gold:"back_5",
                  platinum:"back_7", diamond:"back_10", elite:"back_15" };
    return window.STAY_I18N.t(map[level] || "back_0");
  }

  function renderProgress(){
    const cur = currencySel.value;
    const levelOrder = ["bronze","silver","gold","platinum","diamond","elite"];
    const curLevel = currentLevelByKRW(userSpentKRW);
    const curIdx   = levelOrder.indexOf(curLevel);
    const nextLv   = levelOrder[curIdx+1] || null;

    levelTitle.textContent = window.STAY_I18N.t('ui_your_level') + ": " + cap(curLevel);
    tierBadge.textContent  = percentBack(curLevel);

    if(nextLv){
      const needKRW = LEVELS_KRW[nextLv] - userSpentKRW;
      const needConv = Math.max(0, krwTo(needKRW, cur));
      nextLine.textContent = `${cap(nextLv)} • ${fmtCurrency(needConv, cur)}`;
      const span = LEVELS_KRW[nextLv] - LEVELS_KRW[curLevel];
      const done = Math.min(1, (userSpentKRW - LEVELS_KRW[curLevel]) / span);
      nextFill.style.width = (done*100).toFixed(1) + "%";
      nextPct.textContent = Math.round(done*100) + "%";
    }else{
      nextLine.textContent = window.STAY_I18N.t('ui_top_level');
      nextFill.style.width = "100%";
      nextPct.textContent = "100%";
    }

    // Overall (elite max 기준)
    const overall = Math.min(1, userSpentKRW / LEVELS_KRW.elite);
    gaugeFill.style.width = (overall*100).toFixed(1) + "%";
    progressPct.textContent = Math.round(overall*100) + "%";
  }

  // 혜택 렌더 (상위=하위 포함)
  function renderBenefits(){
    const order = ["bronze","silver","gold","platinum","diamond","elite"];
    const acc = [];
    for (const lv of order){
      acc.push(...(BENEFIT_KEYS[lv]||[]));
      const card = [...tiersGrid.children].find(n => n.dataset.tier.toLowerCase()===lv);
      const wrap = card.querySelector('.benefits');
      wrap.innerHTML = "";
      [...new Set(acc)].forEach(key => {
        const div = document.createElement('div');
        div.className = "benefit";
        const span = document.createElement('span');
        span.setAttribute('data-i18n', key);
        span.textContent = window.STAY_I18N.t(key); // fallback
        div.innerHTML = `<i>✓</i>`;
        div.appendChild(span);
        wrap.appendChild(div);
      });
    }
    // 새로 만든 요소에도 번역 적용
    window.STAY_I18N.applyI18n(window.STAY_I18N.current());
  }

  // 가격 렌더
  let billCycle = "monthly";
  function renderPrices(){
    const cur = currencySel.value;
    const pPlusUSD = PRICING.plus[billCycle];
    const pBlkUSD  = PRICING.black[billCycle];
    pricePlus.textContent = `${fmtCurrency(usdTo(pPlusUSD, cur), cur)} / ${billCycle==='monthly'?'mo':'yr'}`;
    priceBlack.textContent= `${fmtCurrency(usdTo(pBlkUSD, cur),  cur)} / ${billCycle==='monthly'?'mo':'yr'}`;
  }

  // 청구주기 토글
  billMonthly.onclick = () => { billCycle="monthly"; billMonthly.classList.add('active'); billYearly.classList.remove('active'); renderPrices(); };
  billYearly.onclick  = () => { billCycle="yearly";  billYearly.classList.add('active');  billMonthly.classList.remove('active'); renderPrices(); };
  currencySel.onchange = () => { renderPrices(); renderProgress(); };

  // 체크아웃 모달
  let checkoutPlan = null;
  function openCheckout(plan){
    checkoutPlan = plan;
    const cur = currencySel.value;
    const usd = PRICING[plan][billCycle];
    const amt = usdTo(usd, cur);
    co_title.textContent = window.STAY_I18N.t('ui_checkout');
    co_planLine.textContent = `${plan==='plus'?'StayWorld+':'StayWorld Black'} — ${billCycle}`;
    co_amount.textContent = fmtCurrency(amt, cur);
    modal.style.display = "flex";
    payMsg.textContent = "";
    mountPayPalButton(amt, cur);
  }
  function closeCheckout(){ modal.style.display="none"; $("#paypal-container").innerHTML=""; }
  btnClose.onclick = closeCheckout;
  window.addEventListener('keydown', e=>{ if(e.key==='Escape') closeCheckout(); });

  // 플랜 버튼
  $$$('.cta').forEach(btn=>{
    btn.addEventListener('click', ()=>{ openCheckout(btn.dataset.plan); });
  });

  // NOWPayments (Crypto)
  btnCrypto.addEventListener('click', async ()=>{
    try{
      payMsg.textContent = "Creating crypto invoice...";
      const cur = currencySel.value;
      const usd = PRICING[checkoutPlan][billCycle];
      const amt = usdTo(usd, cur);

      const res = await fetch('/.netlify/functions/createNowInvoice', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          amount: Number(amt.toFixed(2)),
          currency: cur,
          orderId: `SW-${checkoutPlan}-${billCycle}-${Date.now()}`,
          successUrl: SUCCESS_URL,
          cancelUrl: CANCEL_URL
        })
      });
      const data = await res.json();
      if(!res.ok) throw new Error(data.error || 'NOWPayments error');
      window.location.href = data.invoice_url;
    }catch(e){
      payMsg.textContent = "Crypto error: " + e.message;
    }
  });

  // PayPal
  function mountPayPalButton(amount, currency){
    $("#paypal-container").innerHTML = "";
    paypal.Buttons({
      createOrder: async () => {
        const res = await fetch('/.netlify/functions/paypalCreateOrder', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ amount: Number(amount.toFixed(2)), currency })
        });
        const data = await res.json();
        if(!res.ok) throw new Error(data.error || 'Failed to create PayPal order');
        return data.id;
      },
      onApprove: async (data) => {
        const res = await fetch('/.netlify/functions/paypalCaptureOrder', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ orderID: data.orderID })
        });
        const capture = await res.json();
        if(!res.ok) throw new Error(capture.error || 'Capture failed');
        window.location.href = SUCCESS_URL + "?order=" + encodeURIComponent(data.orderID);
      },
      onCancel: () => { window.location.href = CANCEL_URL; },
      onError: (err) => { payMsg.textContent = "PayPal error: " + err; }
    }).render('#paypal-container');
  }

  // 초기 렌더
  renderPrices();
  renderBenefits();
  renderProgress();
  // DOM 생성 후 번역 1회 더 적용
  window.STAY_I18N.applyI18n(window.STAY_I18N.current());
  </script>
</body>
</html>
